<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó BYD Kimyoviy Materiallar Ombori</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root{--bg-main:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);--bg-card:rgba(255,255,255,0.98);--bg-input:#f1f5f9;--primary:#0ea5e9;--accent-green:#10b981;--accent-orange:#f59e0b;--accent-red:#ef4444;--accent-blue:#3b82f6;--accent-cyan:#06b6d4;--accent-purple:#8b5cf6;--text-dark:#0f172a;--text-medium:#475569;--text-light:#94a3b8;--border-light:rgba(0,0,0,0.06);--shadow-md:0 4px 20px rgba(0,0,0,0.1);--shadow-lg:0 8px 40px rgba(0,0,0,0.15);--radius-sm:8px;--radius-md:12px;--radius-lg:20px;--radius-xl:28px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Nunito',sans-serif;background:var(--bg-main);min-height:100vh;color:var(--text-dark)}
        ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
        .login-page{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a,#1e293b,#0f172a);display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden}
        .login-page.hidden{display:none}
        .login-bg{position:absolute;inset:0;overflow:hidden}
        .login-bg::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 20% 80%,rgba(14,165,233,0.15) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(6,182,212,0.15) 0%,transparent 50%);animation:bgRotate 30s linear infinite}
        @keyframes bgRotate{to{transform:rotate(360deg)}}
        .login-orb{position:absolute;border-radius:50%;filter:blur(80px);animation:orbFloat 10s ease-in-out infinite}
        .login-orb:nth-child(1){width:350px;height:350px;background:rgba(14,165,233,0.2);top:10%;left:5%}
        .login-orb:nth-child(2){width:280px;height:280px;background:rgba(6,182,212,0.2);top:60%;right:5%;animation-delay:3s}
        @keyframes orbFloat{50%{transform:translate(40px,-40px) scale(1.15)}}
        .login-container{position:relative;z-index:10;width:100%;max-width:460px;padding:20px}
        .login-card{background:rgba(255,255,255,0.97);backdrop-filter:blur(25px);border-radius:var(--radius-xl);padding:45px;box-shadow:0 30px 100px rgba(0,0,0,0.4);animation:cardIn 0.8s cubic-bezier(0.34,1.56,0.64,1)}
        @keyframes cardIn{from{opacity:0;transform:translateY(60px) scale(0.9)}}
        .login-header{text-align:center;margin-bottom:35px}
        .login-logo{width:90px;height:90px;background:linear-gradient(135deg,var(--primary),#0284c7);border-radius:22px;display:flex;align-items:center;justify-content:center;font-size:48px;margin:0 auto 18px;box-shadow:0 20px 50px rgba(14,165,233,0.35);animation:logoFloat 3s ease-in-out infinite}
        @keyframes logoFloat{50%{transform:translateY(-10px)}}
        .login-company{font-size:0.85rem;color:var(--primary);font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
        .login-title{font-size:1.4rem;font-weight:900;background:linear-gradient(135deg,var(--text-dark),var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .login-subtitle{font-size:0.8rem;color:var(--text-light);margin-top:6px}
        .login-form .form-group{margin-bottom:22px}
        .login-form .form-label{display:block;margin-bottom:7px;font-size:0.85rem;font-weight:700;color:var(--text-medium)}
        .login-form .form-input{width:100%;padding:15px 18px;background:var(--bg-input);border:2px solid var(--border-light);border-radius:var(--radius-md);font-family:inherit;font-size:1rem;transition:all 0.3s}
        .login-form .form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(14,165,233,0.15)}
        .login-btn{width:100%;padding:17px;background:linear-gradient(135deg,var(--primary),#0284c7);border:none;border-radius:var(--radius-md);color:white;font-family:inherit;font-size:1rem;font-weight:800;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px}
        .login-btn:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(14,165,233,0.4)}
        .login-error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);padding:12px;margin-bottom:20px;color:var(--accent-red);font-size:0.85rem;text-align:center;display:none}
        .login-error.show{display:block;animation:shake 0.5s}
        @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
        .app-wrapper{display:none}.app-wrapper.active{display:block}
        .app-container{max-width:1900px;margin:0 auto;padding:16px}
        .header{background:var(--bg-card);border-radius:var(--radius-xl);padding:14px 20px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;box-shadow:var(--shadow-lg)}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:50px;height:50px;background:linear-gradient(135deg,var(--primary),#0284c7);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 4px 15px rgba(14,165,233,0.3)}
        .logo-text h1{font-size:1.1rem;font-weight:900;color:var(--text-dark)}.logo-text p{font-size:0.7rem;color:var(--primary);font-weight:600}
        .date-filter-bar{background:var(--bg-card);border-radius:var(--radius-lg);padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;box-shadow:var(--shadow-md)}
        .date-filter-bar .filter-label{font-size:0.85rem;font-weight:700;color:var(--primary);display:flex;align-items:center;gap:6px}
        .date-filter-bar input[type="date"]{padding:8px 12px;border:2px solid var(--border-light);border-radius:var(--radius-sm);font-family:inherit;font-size:0.85rem;background:var(--bg-input);cursor:pointer}
        .date-filter-bar input[type="date"]:focus{border-color:var(--primary);outline:none}
        .date-filter-bar .quick-btns{display:flex;gap:6px;flex-wrap:wrap}
        .date-filter-bar .quick-btn{padding:6px 12px;background:var(--bg-input);border:2px solid var(--border-light);border-radius:var(--radius-sm);font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.2s}
        .date-filter-bar .quick-btn:hover{border-color:var(--primary);color:var(--primary)}
        .date-filter-bar .quick-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .filter-summary{margin-left:auto;display:flex;align-items:center;gap:10px;font-size:0.8rem}
        .filter-summary .badge{background:linear-gradient(135deg,rgba(14,165,233,0.1),rgba(6,182,212,0.1));padding:6px 12px;border-radius:var(--radius-sm);font-weight:700;color:var(--primary)}
        .datetime-widget{display:flex;align-items:center;gap:16px;padding:10px 18px;background:linear-gradient(135deg,rgba(14,165,233,0.08),rgba(6,182,212,0.08));border-radius:var(--radius-md);border:2px solid rgba(14,165,233,0.15)}
        .date-display,.time-display{display:flex;align-items:center;gap:6px;font-weight:700}
        .date-display{color:var(--text-dark)}.time-display{color:var(--primary)}
        .date-display .icon,.time-display .icon{font-size:1.2rem}
        .date-display .text{font-size:0.85rem;font-family:'Space Mono',monospace}
        .time-display .text{font-size:1rem;font-family:'Space Mono',monospace;min-width:75px}
        .header-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .user-info{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg-input);border-radius:var(--radius-md);font-size:0.8rem;font-weight:600}
        .user-info.admin{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(16,185,129,0.05));border:1px solid rgba(16,185,129,0.3);color:var(--accent-green)}
        .user-info.viewer{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.3);color:var(--accent-blue)}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:9px 14px;border:none;border-radius:var(--radius-md);font-family:inherit;font-size:0.8rem;font-weight:700;cursor:pointer;transition:all 0.25s}
        .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#0284c7);color:white}
        .btn-success{background:linear-gradient(135deg,var(--accent-green),#059669);color:white}
        .btn-warning{background:linear-gradient(135deg,var(--accent-orange),#d97706);color:white}
        .btn-danger{background:linear-gradient(135deg,var(--accent-red),#dc2626);color:white}
        .btn-info{background:linear-gradient(135deg,var(--accent-blue),#2563eb);color:white}
        .btn-cyan{background:linear-gradient(135deg,var(--accent-cyan),#0891b2);color:white}
        .btn-purple{background:linear-gradient(135deg,var(--accent-purple),#7c3aed);color:white}
        .btn-ghost{background:var(--bg-input);border:2px solid var(--border-light);color:var(--text-medium)}
        .btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
        .btn-xs{padding:5px 10px;font-size:0.7rem}.btn-sm{padding:6px 10px;font-size:0.7rem}
        .viewer-notice{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:2px solid rgba(59,130,246,0.3);border-radius:var(--radius-md);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .viewer-notice .icon{font-size:1.5rem}.viewer-notice .text{font-size:0.85rem;color:var(--accent-blue);font-weight:600}
        nav{display:flex;gap:4px;background:var(--bg-card);padding:6px;border-radius:var(--radius-lg);margin-bottom:16px;flex-wrap:wrap;box-shadow:var(--shadow-md);overflow-x:auto}
        .nav-tab{padding:10px 16px;border:none;background:transparent;border-radius:var(--radius-md);font-family:inherit;font-size:0.8rem;font-weight:700;color:var(--text-medium);cursor:pointer;transition:all 0.25s;display:flex;align-items:center;gap:6px;white-space:nowrap}
        .nav-tab:hover{background:var(--bg-input)}
        .nav-tab.active{background:linear-gradient(135deg,var(--primary),#0284c7);color:white}
        .nav-tab.ng-tab.active{background:linear-gradient(135deg,var(--accent-orange),#d97706);color:white}
        .nav-tab.admin-only{border:1px dashed rgba(16,185,129,0.4)}
        .card{background:var(--bg-card);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-md);margin-bottom:16px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px}
        .card-title{display:flex;align-items:center;gap:8px;font-size:0.95rem;font-weight:800}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
        .stat-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:14px;position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;transition:all 0.25s}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--stat-color,var(--primary))}
        .stat-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-md)}
        .stat-card.purple{--stat-color:var(--accent-purple)}.stat-card.green{--stat-color:var(--accent-green)}.stat-card.orange{--stat-color:var(--accent-orange)}.stat-card.red{--stat-color:var(--accent-red)}.stat-card.blue{--stat-color:var(--accent-blue)}.stat-card.cyan{--stat-color:var(--accent-cyan)}
        .stat-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--stat-color,var(--primary)),rgba(255,255,255,0.9));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:8px}
        .stat-value{font-size:1.5rem;font-weight:900;font-family:'Space Mono',monospace}
        .stat-label{font-size:0.7rem;color:var(--text-light);font-weight:600;margin-top:3px}
        .stat-percent{font-size:0.65rem;color:var(--stat-color);font-weight:700;margin-top:2px}
        .content-section{display:none}.content-section.active{display:block}
        .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:16px}
        .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:0.75rem}
        thead{background:linear-gradient(135deg,rgba(14,165,233,0.08),rgba(6,182,212,0.08))}
        th{padding:9px 10px;text-align:left;font-weight:700;color:var(--primary);border-bottom:2px solid var(--border-light);font-size:0.7rem;text-transform:uppercase}
        td{padding:9px 10px;border-bottom:1px solid var(--border-light)}
        tbody tr:hover{background:rgba(14,165,233,0.04)}
        tbody tr.clickable{cursor:pointer}
        .material-code{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--primary);font-weight:700;background:rgba(14,165,233,0.1);padding:2px 6px;border-radius:4px}
        .badge{display:inline-flex;padding:2px 7px;border-radius:10px;font-size:0.6rem;font-weight:700;text-transform:uppercase}
        .badge-success{background:rgba(16,185,129,0.15);color:var(--accent-green)}
        .badge-warning{background:rgba(245,158,11,0.15);color:#b45309}
        .badge-danger{background:rgba(239,68,68,0.15);color:var(--accent-red)}
        .badge-info{background:rgba(59,130,246,0.15);color:var(--accent-blue)}
        .badge-renewed{background:rgba(6,182,212,0.15);color:#0891b2}
        .form-group{margin-bottom:12px}
        .form-label{display:block;margin-bottom:4px;font-size:0.75rem;font-weight:700;color:var(--text-medium)}
        .form-control{width:100%;padding:9px 11px;background:var(--bg-input);border:2px solid var(--border-light);border-radius:var(--radius-sm);font-family:inherit;font-size:0.8rem;transition:all 0.25s}
        .form-control:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:var(--radius-xl);width:100%;max-width:800px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-light);position:sticky;top:0;background:var(--bg-card);z-index:10}
        .modal-title{font-size:1rem;font-weight:800;display:flex;align-items:center;gap:8px}
        .modal-close{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:var(--bg-input);border:none;border-radius:6px;cursor:pointer;font-size:1.1rem}
        .modal-close:hover{background:rgba(239,68,68,0.1);color:var(--accent-red)}
        .modal-body{padding:18px 20px}
        .modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:14px 20px;border-top:1px solid var(--border-light)}
        .partiya-list{display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto}
        .partiya-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg-input);border:2px solid var(--border-light);border-radius:var(--radius-sm);cursor:pointer;transition:all 0.2s}
        .partiya-item:hover{border-color:var(--primary);background:rgba(14,165,233,0.05)}
        .partiya-item.selected{border-color:var(--accent-green);background:rgba(16,185,129,0.1)}
        .partiya-item.expired{border-color:var(--accent-orange);background:rgba(245,158,11,0.08)}
        .partiya-item.ng-item{border-color:var(--accent-red);background:rgba(239,68,68,0.08);border-style:dashed}
        .partiya-item.ng-item.selected{border-color:var(--accent-green);background:rgba(16,185,129,0.12);border-style:solid}
        .partiya-info strong{font-family:'Space Mono',monospace;font-size:0.8rem;color:var(--primary)}
        .partiya-info span{font-size:0.65rem;color:var(--text-light);display:block}
        .partiya-qty{font-family:'Space Mono',monospace;font-weight:700}
        .ng-section{margin-top:15px;padding:12px;background:rgba(239,68,68,0.05);border:2px dashed rgba(239,68,68,0.4);border-radius:var(--radius-md)}
        .ng-section-title{font-size:0.8rem;font-weight:700;color:var(--accent-red);margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .chart-container{position:relative;height:220px}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .chart-percent{font-size:1.3rem;font-weight:900;font-family:'Space Mono',monospace}
        .chart-percent.green{color:var(--accent-green)}.chart-percent.red{color:var(--accent-red)}.chart-percent.orange{color:#b45309}
        .search-box{display:flex;gap:8px;flex-wrap:wrap}
        .search-input{flex:1;min-width:140px;position:relative}
        .search-input input{width:100%;padding:9px 11px 9px 32px;background:var(--bg-input);border:2px solid var(--border-light);border-radius:var(--radius-sm);font-family:inherit;font-size:0.8rem}
        .search-input input:focus{outline:none;border-color:var(--primary)}
        .search-input .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%)}
        .filter-select{min-width:120px}
        .history-type{display:inline-flex;padding:2px 7px;border-radius:10px;font-size:0.65rem;font-weight:700}
        .history-type.kirim{background:rgba(16,185,129,0.15);color:var(--accent-green)}
        .history-type.chiqim{background:rgba(239,68,68,0.15);color:var(--accent-red)}
        .history-type.ng{background:rgba(245,158,11,0.15);color:#b45309}
        .history-type.renew{background:rgba(6,182,212,0.15);color:#0891b2}
        .history-type.initial{background:rgba(59,130,246,0.15);color:var(--accent-blue)}
        .history-type.restore{background:rgba(16,185,129,0.15);color:var(--accent-green)}
        .toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
        .toast{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--bg-card);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);margin-top:8px;animation:toastIn 0.3s ease;min-width:240px}
        @keyframes toastIn{from{opacity:0;transform:translateX(100%)}}
        .toast-success{border-left:4px solid var(--accent-green)}
        .toast-error{border-left:4px solid var(--accent-red)}
        .toast-warning{border-left:4px solid var(--accent-orange)}
        .toast-info{border-left:4px solid var(--accent-blue)}
        .toast-message{font-size:0.8rem;font-weight:600}
        .empty-state{text-align:center;padding:30px 20px}
        .empty-state .icon{font-size:2.2rem;margin-bottom:10px;opacity:0.5}
        .empty-state h3{font-size:0.9rem;font-weight:700;margin-bottom:4px}
        .empty-state p{font-size:0.75rem;color:var(--text-light)}
        .file-upload{position:relative;display:flex;flex-direction:column;align-items:center;padding:25px;border:3px dashed var(--border-light);border-radius:var(--radius-lg);cursor:pointer;background:var(--bg-input)}
        .file-upload:hover{border-color:var(--primary)}
        .file-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
        .file-upload .icon{font-size:1.8rem;margin-bottom:8px}
        .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:14px}
        .detail-item{background:var(--bg-input);padding:10px;border-radius:var(--radius-sm)}
        .detail-label{font-size:0.65rem;color:var(--text-light);margin-bottom:2px;text-transform:uppercase}
        .detail-value{font-size:0.95rem;font-weight:700;font-family:'Space Mono',monospace}
        .ng-card{background:linear-gradient(135deg,rgba(245,158,11,0.05),rgba(245,158,11,0.1));border:2px solid rgba(245,158,11,0.3);border-radius:var(--radius-lg);padding:14px;margin-bottom:10px}
        .ng-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
        .ng-card-title{font-weight:700;color:#b45309}
        .history-scroll{max-height:300px;overflow-y:auto;border:1px solid var(--border-light);border-radius:var(--radius-md);margin-top:10px}
        .history-scroll table{margin:0}
        .history-scroll thead{position:sticky;top:0;z-index:1}
        .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap}
        .pagination button{padding:6px 12px;border:2px solid var(--border-light);background:var(--bg-input);border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;font-size:0.75rem;font-weight:600;transition:all 0.2s}
        .pagination button:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        .pagination button.active{background:var(--primary);color:white;border-color:var(--primary)}
        .settings-card{background:linear-gradient(135deg,rgba(14,165,233,0.03),rgba(6,182,212,0.03));border:2px solid rgba(14,165,233,0.1);border-radius:var(--radius-lg);padding:18px;margin-bottom:14px}
        .settings-card h4{color:var(--primary);margin-bottom:14px;font-size:0.9rem}
        .cert-card{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(135deg,rgba(6,182,212,0.05),rgba(6,182,212,0.1));border:1px solid rgba(6,182,212,0.2);border-radius:var(--radius-sm);margin-bottom:8px}
        .cert-card-header{display:flex;align-items:center;gap:10px}
        .cert-card-icon{font-size:1.5rem}
        .cert-card-info h4{font-size:0.8rem;font-weight:700;margin-bottom:2px;color:#0891b2}
        .cert-card-info p{font-size:0.7rem;color:var(--text-light)}
        .cert-actions{display:flex;gap:6px}
        .export-buttons{display:flex;flex-wrap:wrap;gap:8px}
        .server-info{background:linear-gradient(135deg,rgba(139,92,246,0.05),rgba(139,92,246,0.1));border:2px solid rgba(139,92,246,0.2);border-radius:var(--radius-lg);padding:16px;margin-bottom:16px}
        .server-info h4{color:var(--accent-purple);margin-bottom:12px}
        @media(max-width:768px){.header{padding:10px 14px}.grid-2,.grid-3{grid-template-columns:1fr}.stats-grid{grid-template-columns:repeat(2,1fr)}.datetime-widget{display:none}.date-filter-bar{flex-direction:column;align-items:stretch}.filter-summary{margin-left:0;justify-content:center}.slide{padding:25px 20px;border-radius:20px;max-height:calc(100vh - 180px)}.slide-header{margin-bottom:20px}.slide-icon{font-size:2.5rem}.slide-title{font-size:1.3rem}.slide-stats{grid-template-columns:repeat(2,1fr);gap:10px}.slide-stat{padding:15px 10px}.slide-stat-icon{font-size:1.8rem}.slide-stat-value{font-size:1.5rem}.slide-table{font-size:0.75rem}.slide-table th,.slide-table td{padding:8px 10px}.presentation-header{padding:12px 15px;flex-wrap:wrap;gap:10px}.presentation-title{font-size:1rem}.presentation-title .byd-badge{padding:6px 12px;font-size:0.8rem}.presentation-controls{gap:6px}.presentation-controls span{padding:6px 10px;font-size:0.8rem}.pres-btn{padding:8px 12px;font-size:0.75rem}.presentation-content{padding:15px}.presentation-nav{padding:15px;gap:8px}.nav-dot{width:10px;height:10px}}
        @media(max-width:480px){.slide-stats{grid-template-columns:1fr}.slide-table-container{max-height:180px}.presentation-controls span{display:none}.stats-grid{grid-template-columns:repeat(3,1fr)}}
        .hidden{display:none!important}
        /* ULTRA MODERN PRESENTATION */
        .presentation-overlay{position:fixed;inset:0;background:#000;z-index:2000;display:none;flex-direction:column;overflow:hidden}
        .presentation-overlay.active{display:flex}
        .presentation-overlay::before{content:'';position:absolute;inset:0;background:linear-gradient(125deg,#0f172a 0%,#1e1b4b 25%,#0f172a 50%,#164e63 75%,#0f172a 100%);background-size:400% 400%;animation:gradientShift 15s ease infinite}
        @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .presentation-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none}
        .particle{position:absolute;width:4px;height:4px;background:rgba(14,165,233,0.6);border-radius:50%;animation:particleFloat 20s infinite linear}
        @keyframes particleFloat{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-100vh) scale(1);opacity:0}}
        .presentation-header{position:relative;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:20px 40px;background:rgba(0,0,0,0.3);backdrop-filter:blur(20px);border-bottom:1px solid rgba(14,165,233,0.2)}
        .presentation-title{color:white;font-size:1.4rem;font-weight:900;display:flex;align-items:center;gap:16px}
        .presentation-title .byd-badge{background:linear-gradient(135deg,#0ea5e9,#06b6d4);padding:10px 20px;border-radius:12px;font-size:1rem;animation:badgePulse 2s ease-in-out infinite}
        @keyframes badgePulse{0%,100%{box-shadow:0 0 20px rgba(14,165,233,0.5)}50%{box-shadow:0 0 40px rgba(14,165,233,0.8)}}
        .presentation-controls{display:flex;gap:12px;align-items:center}
        .presentation-controls span{font-family:'Space Mono',monospace;background:rgba(255,255,255,0.1);padding:10px 20px;border-radius:10px;font-size:1rem;color:white;border:1px solid rgba(255,255,255,0.1)}
        .pres-btn{padding:12px 20px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:white;font-family:inherit;font-weight:700;cursor:pointer;transition:all 0.3s}
        .pres-btn:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
        .pres-btn.danger{background:rgba(239,68,68,0.3);border-color:rgba(239,68,68,0.5)}
        .pres-btn.danger:hover{background:rgba(239,68,68,0.5)}
        .presentation-content{position:relative;z-index:10;flex:1;display:flex;align-items:center;justify-content:center;padding:40px;overflow-y:auto}
        .presentation-nav{position:relative;z-index:10;display:flex;justify-content:center;gap:12px;padding:25px;background:rgba(0,0,0,0.4);backdrop-filter:blur(20px)}
        .nav-dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.3);cursor:pointer;transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55)}
        .nav-dot:hover{background:rgba(14,165,233,0.5);transform:scale(1.3)}
        .nav-dot.active{background:linear-gradient(135deg,#0ea5e9,#06b6d4);border-color:#0ea5e9;transform:scale(1.4);box-shadow:0 0 20px rgba(14,165,233,0.6)}
        .slide{position:relative;background:rgba(255,255,255,0.98);border-radius:30px;padding:40px 50px;max-width:1100px;width:100%;min-height:auto;max-height:calc(100vh - 200px);overflow-y:auto;animation:slideIn 0.7s cubic-bezier(0.68,-0.55,0.265,1.55);box-shadow:0 30px 100px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.1)}
        .slide::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg,#0ea5e9,#06b6d4,#8b5cf6,#f59e0b,#ef4444);background-size:200% 100%;animation:gradientLine 3s linear infinite}
        @keyframes gradientLine{to{background-position:-200% 0}}
        @keyframes slideIn{from{opacity:0;transform:translateY(50px) scale(0.95) rotateX(10deg)}to{opacity:1;transform:translateY(0) scale(1) rotateX(0)}}
        .slide-header{text-align:center;margin-bottom:35px;position:relative}
        .slide-icon{font-size:4rem;margin-bottom:15px;display:block;animation:iconBounce 2s ease-in-out infinite}
        @keyframes iconBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .slide-title{font-size:2rem;font-weight:900;background:linear-gradient(135deg,#0f172a,#0ea5e9,#06b6d4);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:titleShine 3s linear infinite;margin-bottom:8px}
        @keyframes titleShine{to{background-position:200% center}}
        .slide-subtitle{font-size:1rem;color:var(--text-light);font-weight:600}
        .slide-date{font-size:0.9rem;color:var(--primary);margin-top:10px;font-weight:700;display:inline-flex;align-items:center;gap:8px;background:rgba(14,165,233,0.1);padding:8px 16px;border-radius:20px}
        .slide-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;margin:30px 0}
        .slide-stat{text-align:center;padding:25px 15px;background:linear-gradient(145deg,#f8fafc,#e2e8f0);border-radius:20px;position:relative;overflow:hidden;transition:all 0.4s;cursor:default}
        .slide-stat::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--stat-bg,linear-gradient(90deg,#0ea5e9,#06b6d4))}
        .slide-stat::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,0.5));opacity:0;transition:opacity 0.3s}
        .slide-stat:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 40px rgba(0,0,0,0.1)}
        .slide-stat:hover::after{opacity:1}
        .slide-stat.green::before{--stat-bg:linear-gradient(90deg,#10b981,#059669)}
        .slide-stat.red::before{--stat-bg:linear-gradient(90deg,#ef4444,#dc2626)}
        .slide-stat.orange::before{--stat-bg:linear-gradient(90deg,#f59e0b,#d97706)}
        .slide-stat.cyan::before{--stat-bg:linear-gradient(90deg,#06b6d4,#0891b2)}
        .slide-stat.blue::before{--stat-bg:linear-gradient(90deg,#3b82f6,#2563eb)}
        .slide-stat.purple::before{--stat-bg:linear-gradient(90deg,#8b5cf6,#7c3aed)}
        .slide-stat-icon{font-size:2.5rem;margin-bottom:10px;animation:statIconPulse 2s ease-in-out infinite}
        @keyframes statIconPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .slide-stat-value{font-size:2.2rem;font-weight:900;font-family:'Space Mono',monospace;color:var(--text-dark);position:relative;z-index:1}
        .slide-stat.green .slide-stat-value{color:#10b981}
        .slide-stat.red .slide-stat-value{color:#ef4444}
        .slide-stat.orange .slide-stat-value{color:#b45309}
        .slide-stat.cyan .slide-stat-value{color:#0891b2}
        .slide-stat-label{font-size:0.85rem;color:var(--text-medium);margin-top:5px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
        .slide-stat-sub{font-size:0.75rem;color:var(--text-light);margin-top:3px}
        .slide-table-container{max-height:220px;overflow-y:auto;border-radius:15px;border:2px solid var(--border-light);margin-top:15px;background:white}
        .slide-table{width:100%;border-collapse:collapse;font-size:0.8rem}
        .slide-table thead{background:linear-gradient(135deg,rgba(14,165,233,0.1),rgba(6,182,212,0.1));position:sticky;top:0}
        .slide-table th{padding:14px 16px;text-align:left;font-weight:800;color:var(--primary);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px}
        .slide-table td{padding:12px 16px;border-bottom:1px solid var(--border-light);transition:background 0.2s}
        .slide-table tbody tr:hover{background:rgba(14,165,233,0.05)}
        .slide-table .code{font-family:'Space Mono',monospace;color:var(--primary);font-weight:700;background:rgba(14,165,233,0.1);padding:4px 10px;border-radius:6px;font-size:0.8rem}
        .slide-table .value{font-family:'Space Mono',monospace;font-weight:700;font-size:0.9rem}
        .slide-table .value.green{color:#10b981}.slide-table .value.red{color:#ef4444}.slide-table .value.orange{color:#b45309}
        .slide-empty{text-align:center;padding:50px;color:var(--text-light)}
        .slide-empty .icon{font-size:5rem;margin-bottom:20px;opacity:0.5;animation:emptyPulse 2s ease-in-out infinite}
        @keyframes emptyPulse{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.1);opacity:0.8}}
        .slide-empty h3{font-size:1.3rem;color:var(--accent-green);font-weight:800;margin-bottom:5px}
        .slide-empty p{font-size:0.9rem}
        .slide-footer{text-align:center;margin-top:30px;padding-top:25px;border-top:2px solid var(--border-light);position:relative}
        .slide-footer::before{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:100px;height:4px;background:linear-gradient(90deg,#0ea5e9,#06b6d4);border-radius:2px}
        .slide-footer .logo{display:flex;align-items:center;justify-content:center;gap:12px;font-size:1.1rem;font-weight:900;color:var(--text-dark)}
        .slide-footer .logo span{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;padding:8px 16px;border-radius:10px;font-size:0.95rem;animation:logoPulse 2s ease-in-out infinite}
        @keyframes logoPulse{0%,100%{box-shadow:0 5px 20px rgba(14,165,233,0.3)}50%{box-shadow:0 5px 30px rgba(14,165,233,0.5)}}
        .slide-footer p{color:var(--text-light);font-size:0.85rem;margin-top:8px}
        .slide-footer .highlight{color:var(--primary);font-weight:700}
        .progress-ring{position:absolute;top:20px;right:20px;width:60px;height:60px}
        .progress-ring circle{fill:none;stroke-width:4;transform:rotate(-90deg);transform-origin:50% 50%}
        .progress-ring .bg{stroke:rgba(14,165,233,0.1)}
        .progress-ring .progress{stroke:url(#progressGradient);stroke-linecap:round;stroke-dasharray:157;stroke-dashoffset:157;animation:progressFill 1s ease-out forwards}
        @keyframes progressFill{to{stroke-dashoffset:var(--progress)}}
        .progress-ring text{font-size:12px;font-weight:700;fill:var(--primary)}
    </style>
</head>
<body>
    <div class="login-page" id="login-page">
        <div class="login-bg" id="login-bg"><div class="login-orb"></div><div class="login-orb"></div></div>
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">üöó</div>
                    <div class="login-company">"BYD UZBEKISTAN FACTORY" QK MCHJ</div>
                    <div class="login-title">Kimyoviy Materiallar</div>
                    <div class="login-subtitle">Saqlash Ombori Boshqaruv Tizimi</div>
                </div>
                <div class="login-error" id="login-error">Login yoki parol noto'g'ri</div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group"><label class="form-label">üë§ Login</label><input type="text" class="form-input" id="login-username" placeholder="Login kiriting" required autocomplete="off"></div>
                    <div class="form-group"><label class="form-label">üîí Parol</label><input type="password" class="form-input" id="login-password" placeholder="Parol kiriting" required autocomplete="new-password"></div>
                    <button type="submit" class="login-btn" id="login-btn">üöÄ Kirish</button>
                </form>
            </div>
        </div>
    </div>
    <div class="app-wrapper" id="app-wrapper">
        <div class="app-container">
            <header class="header">
                <div class="logo"><div class="logo-icon">üöó</div><div class="logo-text"><h1>BYD Kimyoviy Materiallar</h1><p>Saqlash Ombori</p></div></div>
                <div class="datetime-widget"><div class="date-display"><span class="icon">üìÖ</span><span class="text" id="current-date">--</span></div><div class="time-display"><span class="icon">üïê</span><span class="text" id="current-time">--:--:--</span></div></div>
                <div class="header-actions">
                    <div class="user-info" id="user-info"><span>üë§</span><span id="current-user">-</span></div>
                    <button class="btn btn-purple" onclick="startPresentation()">üìä Hisobot</button>
                    <button class="btn btn-danger" onclick="handleLogout()">üö™ Chiqish</button>
                </div>
            </header>
            <div class="date-filter-bar">
                <div class="filter-label">üìÖ Davr:</div>
                <input type="date" id="filter-start-date" onchange="applyDateFilter()">
                <span>‚Äî</span>
                <input type="date" id="filter-end-date" onchange="applyDateFilter()">
                <div class="quick-btns">
                    <button class="quick-btn active" onclick="setDateRange('all',this)">Barchasi</button>
                    <button class="quick-btn" onclick="setDateRange('today',this)">Bugun</button>
                    <button class="quick-btn" onclick="setDateRange('week',this)">Hafta</button>
                    <button class="quick-btn" onclick="setDateRange('month',this)">Oy</button>
                    <button class="quick-btn" onclick="setDateRange('year',this)">Yil</button>
                </div>
                <div class="filter-summary"><span class="badge" id="filter-ops-count">0 operatsiya</span></div>
            </div>
            <div class="viewer-notice hidden" id="viewer-notice"><span class="icon">üëÅÔ∏è</span><span class="text">Siz kuzatuvchi sifatida kirgansiz. Faqat ko'rish imkoniyati mavjud.</span></div>
            <nav id="main-nav">
                <button class="nav-tab active" onclick="showSection('dashboard',this)">üìä Dashboard</button>
                <button class="nav-tab" onclick="showSection('materials',this)">üß™ Materiallar</button>
                <button class="nav-tab" onclick="showSection('expiring',this)">‚è∞ Muddati yaqin</button>
                <button class="nav-tab admin-only" onclick="showSection('operations',this)">‚ö° Operatsiyalar</button>
                <button class="nav-tab ng-tab admin-only" onclick="showSection('ng',this)">‚ö†Ô∏è NG</button>
                <button class="nav-tab" onclick="showSection('history',this)">üìã Tarix</button>
                <button class="nav-tab" onclick="showSection('reports',this)">üìà Hisobotlar</button>
                <button class="nav-tab" onclick="showSection('certificates',this)">üìú Sertifikatlar</button>
                <button class="nav-tab admin-only" onclick="showSection('import',this)">üì• Import</button>
                <button class="nav-tab admin-only" onclick="showSection('settings',this)">‚öôÔ∏è Sozlamalar</button>
            </nav>
            <section class="content-section active" id="section-dashboard">
                <div class="stats-grid">
                    <div class="stat-card purple" onclick="showStatDetail('total')"><div class="stat-icon">üì¶</div><div class="stat-value" id="stat-total">0</div><div class="stat-label">Jami</div></div>
                    <div class="stat-card green" onclick="showStatDetail('ok')"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-ok">0</div><div class="stat-label">Yetarli</div><div class="stat-percent" id="stat-ok-pct">0%</div></div>
                    <div class="stat-card orange" onclick="showStatDetail('warning')"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="stat-warning">0</div><div class="stat-label">Kam</div><div class="stat-percent" id="stat-warning-pct">0%</div></div>
                    <div class="stat-card red" onclick="showStatDetail('critical')"><div class="stat-icon">üö®</div><div class="stat-value" id="stat-critical">0</div><div class="stat-label">Kritik</div><div class="stat-percent" id="stat-critical-pct">0%</div></div>
                    <div class="stat-card red" onclick="showStatDetail('expired')"><div class="stat-icon">‚ùå</div><div class="stat-value" id="stat-expired">0</div><div class="stat-label">Muddat O'tgan</div><div class="stat-percent" id="stat-expired-pct">0%</div></div>
                    <div class="stat-card cyan" onclick="showStatDetail('renewed')"><div class="stat-icon">üîÑ</div><div class="stat-value" id="stat-renewed">0</div><div class="stat-label">Yangilangan</div><div class="stat-percent" id="stat-renewed-pct">0%</div></div>
                    <div class="stat-card orange" onclick="showStatDetail('ng')"><div class="stat-icon">üö´</div><div class="stat-value" id="stat-ng">0</div><div class="stat-label">NG</div><div class="stat-percent" id="stat-ng-pct">0</div></div>
                    <div class="stat-card blue" onclick="showStatDetail('kirim')"><div class="stat-icon">üì•</div><div class="stat-value" id="stat-kirim">0</div><div class="stat-label">Kirim</div></div>
                    <div class="stat-card red" onclick="showStatDetail('chiqim')"><div class="stat-icon">üì§</div><div class="stat-value" id="stat-chiqim">0</div><div class="stat-label">Chiqim</div></div>
                </div>
                <div class="grid-2">
                    <div class="card"><div class="chart-header"><div class="card-title">üì• Kirim (Top 10)</div><div class="chart-percent green" id="kirim-percent">0%</div></div><div class="chart-container"><canvas id="kirimChart"></canvas></div></div>
                    <div class="card"><div class="chart-header"><div class="card-title">üì§ Chiqim (Top 10)</div><div class="chart-percent red" id="chiqim-percent">0%</div></div><div class="chart-container"><canvas id="chiqimChart"></canvas></div></div>
                </div>
                <div class="grid-2">
                    <div class="card"><div class="chart-header"><div class="card-title">üìä Oylik</div></div><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">üóÇÔ∏è Kategoriya</div></div><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
                </div>
                <div class="card"><div class="card-header"><div class="card-title">üïê So'nggi operatsiyalar</div></div><div class="table-container"><table><thead><tr><th>Sana</th><th>Material</th><th>Turi</th><th>Miqdor</th><th>Izoh</th></tr></thead><tbody id="recent-activity"></tbody></table></div></div>
            </section>
            <section class="content-section" id="section-materials">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üß™ Materiallar (<span id="materials-count">0</span>)</div>
                        <div class="search-box">
                            <div class="search-input"><span class="icon">üîç</span><input type="text" id="search-materials" placeholder="Qidirish..." oninput="renderMaterials()"></div>
                            <select class="form-control filter-select" id="filter-status" onchange="renderMaterials()"><option value="">Barchasi</option><option value="ok">Yetarli</option><option value="warning">Kam</option><option value="critical">Kritik</option><option value="expired">Muddat</option><option value="renewed">Yangilangan</option></select>
                            <button class="btn btn-success" onclick="exportMaterialsExcel()">üìä Excel</button>
                            <button class="btn btn-primary admin-only" onclick="openMaterialModal()">‚ûï Qo'shish</button>
                        </div>
                    </div>
                    <div class="table-container"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Birlik</th><th>Min</th><th>Kirim</th><th>Chiqim</th><th>NG</th><th>Qoldiq</th><th>Status</th><th>Amal</th></tr></thead><tbody id="materials-table"></tbody></table></div>
                </div>
            </section>
            <section class="content-section" id="section-expiring">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title" style="color:var(--accent-orange)">‚è∞ Muddati Yaqin Materiallar (10 kun ichida)</div>
                        <button class="btn btn-success" onclick="exportExpiringExcel()">üìä Excel</button>
                    </div>
                    <div class="table-container"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Partiya</th><th>Muddat</th><th>Qolgan kun</th><th>Qoldiq</th><th>Status</th></tr></thead><tbody id="expiring-table-list"></tbody></table></div>
                </div>
            </section>
            <section class="content-section" id="section-operations">
                <div class="grid-3">
                    <div class="card"><div class="card-header"><div class="card-title" style="color:var(--accent-green)">üì• Kirim</div></div>
                        <form onsubmit="handleKirim(event)">
                            <div class="form-group"><label class="form-label">Material</label><select class="form-control" id="kirim-material" required><option value="">Tanlang...</option></select></div>
                            <div class="form-group"><label class="form-label">Miqdor</label><input type="number" class="form-control" id="kirim-qty" step="0.000001" min="0.000001" required></div>
                            <div class="form-row"><div class="form-group"><label class="form-label">Boshi</label><input type="date" class="form-control" id="kirim-start" required></div><div class="form-group"><label class="form-label">Oxi</label><input type="date" class="form-control" id="kirim-end" required></div></div>
                            <div class="form-group"><label class="form-label">Sana</label><input type="date" class="form-control" id="kirim-date"></div>
                            <div class="form-group"><label class="form-label">Izoh</label><input type="text" class="form-control" id="kirim-note"></div>
                            <button type="submit" class="btn btn-success" style="width:100%">‚úÖ Kirim Saqlash</button>
                        </form>
                    </div>
                    <div class="card"><div class="card-header"><div class="card-title" style="color:var(--accent-red)">üì§ Chiqim</div></div>
                        <form onsubmit="handleChiqim(event)">
                            <div class="form-group"><label class="form-label">Material</label><select class="form-control" id="chiqim-material" required onchange="loadPartiyalar('chiqim')"><option value="">Tanlang...</option></select></div>
                            <div class="form-group" id="chiqim-partiya-cont" style="display:none"><label class="form-label">Partiya (FIFO)</label><div class="partiya-list" id="chiqim-partiya-list"></div></div>
                            <div class="form-group"><label class="form-label">Miqdor</label><input type="number" class="form-control" id="chiqim-qty" step="0.000001" min="0.000001" required></div>
                            <div class="form-group"><label class="form-label">Sana</label><input type="date" class="form-control" id="chiqim-date"></div>
                            <div class="form-group"><label class="form-label">Izoh</label><input type="text" class="form-control" id="chiqim-note"></div>
                            <button type="submit" class="btn btn-danger" style="width:100%">üì§ Chiqim Saqlash</button>
                        </form>
                    </div>
                    <div class="card"><div class="card-header"><div class="card-title" style="color:var(--accent-cyan)">üîÑ Muddat Yangilash</div></div>
                        <form onsubmit="handleRenew(event)" id="renew-form">
                            <div class="form-group"><label class="form-label">Material</label><select class="form-control" id="renew-material" required onchange="loadRenewOptions()"><option value="">Tanlang...</option></select></div>
                            <div class="form-group" id="renew-partiya-cont" style="display:none"><label class="form-label">üì¶ Partiya tanlang</label><div class="partiya-list" id="renew-partiya-list"></div></div>
                            <div class="ng-section" id="renew-ng-section" style="display:none"><div class="ng-section-title">‚ö†Ô∏è NG dan qaytarish (Muddat o'tgan)</div><div class="partiya-list" id="renew-ng-list"></div></div>
                            <div class="form-row"><div class="form-group"><label class="form-label">Yangi Boshi</label><input type="date" class="form-control" id="renew-start" required></div><div class="form-group"><label class="form-label">Yangi Oxi</label><input type="date" class="form-control" id="renew-end" required></div></div>
                            <div class="form-group"><label class="form-label">üìé Sertifikat (PDF)</label><input type="file" class="form-control" id="renew-cert" accept=".pdf" style="padding:7px"></div>
                            <div class="form-group"><label class="form-label">Izoh</label><input type="text" class="form-control" id="renew-note"></div>
                            <button type="submit" class="btn btn-cyan" style="width:100%">üîÑ Muddat Yangilash</button>
                        </form>
                    </div>
                </div>
                <div class="card"><div class="card-header"><div class="card-title" style="color:#b45309">‚ö†Ô∏è NG (Yaroqsiz)</div></div>
                    <div class="grid-3">
                        <div class="form-group"><label class="form-label">Material</label><select class="form-control" id="ng-material" onchange="loadPartiyalar('ng')"><option value="">Tanlang...</option></select></div>
                        <div class="form-group" id="ng-partiya-cont" style="display:none"><label class="form-label">Partiya</label><div class="partiya-list" id="ng-partiya-list"></div></div>
                        <div class="form-group"><label class="form-label">Miqdor</label><input type="number" class="form-control" id="ng-qty" step="0.000001" min="0.000001"></div>
                        <div class="form-group"><label class="form-label">Sabab</label><select class="form-control" id="ng-reason"><option value="">Tanlang...</option><option value="expired">Muddat o'tgan</option><option value="damaged">Buzilgan</option><option value="quality">Sifatsiz</option></select></div>
                        <div class="form-group"><label class="form-label">Izoh</label><input type="text" class="form-control" id="ng-note"></div>
                        <div><button class="btn btn-warning" style="width:100%;margin-top:20px" onclick="handleNG()">‚ö†Ô∏è NG Saqlash</button></div>
                    </div>
                </div>
            </section>
            <section class="content-section" id="section-ng">
                <div class="card">
                    <div class="card-header"><div class="card-title" style="color:#b45309">‚ö†Ô∏è NG Materiallar</div><div class="search-box"><div class="search-input"><span class="icon">üîç</span><input type="text" id="search-ng" placeholder="Qidirish..." oninput="renderNGList()"></div><button class="btn btn-success" onclick="exportNGExcel()">üìä Excel</button></div></div>
                    <div id="ng-list-container"></div>
                </div>
            </section>
            <section class="content-section" id="section-history">
                <div class="card">
                    <div class="card-header"><div class="card-title">üìã Tarix</div><div class="search-box"><div class="search-input"><span class="icon">üîç</span><input type="text" id="search-history" placeholder="Qidirish..." oninput="renderHistory()"></div><select class="form-control filter-select" id="filter-type" onchange="renderHistory()"><option value="">Barchasi</option><option value="kirim">Kirim</option><option value="chiqim">Chiqim</option><option value="ng">NG</option><option value="renew">Yangilash</option><option value="restore">Qaytarish</option><option value="initial">Qoldiq</option></select><button class="btn btn-success" onclick="exportHistoryExcel()">üìä Excel</button></div></div>
                    <div class="table-container"><table><thead><tr><th>ID</th><th>Sana</th><th>Material</th><th>Turi</th><th>Partiya</th><th>Miqdor</th><th>Izoh</th><th class="admin-only">Amal</th></tr></thead><tbody id="history-table"></tbody></table></div>
                    <div class="pagination" id="history-pagination"></div>
                </div>
            </section>
            <section class="content-section" id="section-reports">
                <div class="grid-2">
                    <div class="card"><div class="card-header"><div class="card-title">üìä Xulosa</div><button class="btn btn-success btn-sm" onclick="exportSummaryExcel()">üìä Excel</button></div><div class="table-container"><table><thead><tr><th>‚Ññ</th><th>Material</th><th>Kirim</th><th>Chiqim</th><th>NG</th><th>Qoldiq</th></tr></thead><tbody id="summary-table"></tbody></table></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">üìÖ Yaroqlilik</div><button class="btn btn-success btn-sm" onclick="exportExpiryExcel()">üìä Excel</button></div><div class="table-container"><table><thead><tr><th>Material</th><th>Partiya</th><th>Muddat</th><th>Qoldiq</th><th>Status</th></tr></thead><tbody id="expiry-table"></tbody></table></div></div>
                </div>
            </section>
            <section class="content-section" id="section-certificates">
                <div class="card"><div class="card-header"><div class="card-title">üìú Sertifikatlar</div><button class="btn btn-success" onclick="exportCertificatesExcel()">üìä Excel</button></div><div id="certificates-list"></div></div>
            </section>
            <section class="content-section" id="section-import">
                <div class="grid-2">
                    <div class="card"><div class="card-header"><div class="card-title">üì• Excel Import</div></div><div class="file-upload"><input type="file" accept=".xlsx,.xls,.csv" onchange="handleExcelImport(event)"><span class="icon">üìÑ</span><p><strong>Excel faylni</strong> tanlang</p></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">üì§ Export</div></div><div class="export-buttons"><button class="btn btn-primary" onclick="downloadTemplate()">üì• Namuna</button><button class="btn btn-success" onclick="exportAllToExcel()">üìä Hammasi</button></div></div>
                </div>
            </section>
            <section class="content-section" id="section-settings">
                <div class="grid-2">
                    <div class="card">
                        <div class="server-info"><h4>üíæ Server Ma'lumotlari</h4><div class="detail-grid"><div class="detail-item"><div class="detail-label">Materiallar</div><div class="detail-value" id="info-mats">0</div></div><div class="detail-item"><div class="detail-label">Partiyalar</div><div class="detail-value" id="info-parts">0</div></div><div class="detail-item"><div class="detail-label">Operatsiyalar</div><div class="detail-value" id="info-ops">0</div></div><div class="detail-item"><div class="detail-label">Sertifikatlar</div><div class="detail-value" id="info-certs">0</div></div></div></div>
                        <button class="btn btn-info" onclick="exportBackup()">üíæ JSON Backup</button>
                        <div style="margin-top:10px"><label class="form-label">üìÅ JSON Tiklash</label><input type="file" class="form-control" accept=".json" onchange="importBackup(event)" style="padding:7px"></div>
                        <div class="settings-card" style="margin-top:15px;background:linear-gradient(135deg,rgba(239,68,68,0.05),rgba(239,68,68,0.1));border:2px solid rgba(239,68,68,0.3)">
                            <h4 style="color:var(--accent-red)">üóëÔ∏è Barcha operatsiyalarni o'chirish</h4>
                            <p style="font-size:0.75rem;color:var(--text-medium);margin-bottom:10px">‚ö†Ô∏è Diqqat! Bu amal barcha partiyalar, operatsiyalar, NG yozuvlar va sertifikatlarni o'chirib yuboradi. Materiallar saqlanib qoladi.</p>
                            <button class="btn btn-danger" onclick="openDeleteAllModal()">üóëÔ∏è Barchasini o'chirish</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="settings-card"><h4>üîê Login/Parol</h4>
                            <form onsubmit="changeCredentials(event)">
                                <div class="form-group"><label class="form-label">Joriy parol</label><input type="password" class="form-control" id="current-password" required autocomplete="new-password"></div>
                                <div class="form-group"><label class="form-label">Yangi login</label><input type="text" class="form-control" id="new-login" required></div>
                                <div class="form-group"><label class="form-label">Yangi parol</label><input type="password" class="form-control" id="new-password" required autocomplete="new-password"></div>
                                <div class="form-group"><label class="form-label">Parolni tasdiqlash</label><input type="password" class="form-control" id="confirm-password" required autocomplete="new-password"></div>
                                <button type="submit" class="btn btn-primary" style="width:100%">üíæ Saqlash</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div class="modal-overlay" id="material-modal"><div class="modal" style="max-width:500px"><div class="modal-header"><div class="modal-title">üß™ <span id="material-modal-title">Yangi Material</span></div><button class="modal-close" onclick="closeModal('material-modal')">√ó</button></div><div class="modal-body"><form id="form-material" onsubmit="saveMaterial(event)"><input type="hidden" id="material-id"><div class="form-row"><div class="form-group"><label class="form-label">Kod *</label><input type="text" class="form-control" id="material-code" required></div><div class="form-group"><label class="form-label">Birlik</label><input type="text" class="form-control" id="material-unit" list="unit-list" placeholder="litr, kg, dona..."><datalist id="unit-list"><option value="litr"><option value="kg"><option value="dona"><option value="metr"><option value="komplekt"><option value="quti"><option value="pachka"><option value="bochka"><option value="ballonlar"><option value="tonna"></datalist></div></div><div class="form-group"><label class="form-label">Nomi *</label><input type="text" class="form-control" id="material-name" required></div><div class="form-row"><div class="form-group"><label class="form-label">Yaroqlilik (oy)</label><input type="number" class="form-control" id="material-expiry" value="12"></div><div class="form-group"><label class="form-label">‚ö†Ô∏è Minimum miqdori</label><input type="number" class="form-control" id="material-min" value="10" step="0.01" min="0" placeholder="Minimum qoldiq"></div></div><div class="form-group"><label class="form-label">Kategoriya</label><select class="form-control" id="material-cat"><option value="oil">Moy</option><option value="chemical">Kimyoviy</option><option value="gas">Gaz</option><option value="other">Boshqa</option></select></div></form></div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('material-modal')">Bekor</button><button class="btn btn-primary" onclick="document.getElementById('form-material').requestSubmit()">üíæ Saqlash</button></div></div></div>
    <div class="modal-overlay" id="history-modal"><div class="modal" style="max-width:900px"><div class="modal-header"><div class="modal-title">üìã <span id="history-modal-title">Tarix</span></div><button class="modal-close" onclick="closeModal('history-modal')">√ó</button></div><div class="modal-body" id="history-modal-content"></div></div></div>
    <div class="modal-overlay" id="cert-modal"><div class="modal" style="max-width:900px;height:85vh"><div class="modal-header"><div class="modal-title">üìú <span id="cert-modal-title">Sertifikat</span></div><button class="modal-close" onclick="closeModal('cert-modal')">√ó</button></div><div class="modal-body" style="height:calc(100% - 60px);padding:0"><iframe id="cert-iframe" style="width:100%;height:100%;border:none"></iframe></div></div></div>
    <div class="modal-overlay" id="ng-detail-modal"><div class="modal" style="max-width:650px"><div class="modal-header"><div class="modal-title">‚ö†Ô∏è <span id="ng-detail-title">NG</span></div><button class="modal-close" onclick="closeModal('ng-detail-modal')">√ó</button></div><div class="modal-body" id="ng-detail-content"></div></div></div>
    <div class="modal-overlay" id="stat-detail-modal"><div class="modal" style="max-width:900px"><div class="modal-header"><div class="modal-title"><span id="stat-detail-title">Statistika</span></div><button class="modal-close" onclick="closeModal('stat-detail-modal')">√ó</button></div><div class="modal-body" id="stat-detail-content"></div></div></div>
    <div class="modal-overlay" id="confirm-modal"><div class="modal" style="max-width:380px"><div class="modal-header"><div class="modal-title">‚ö†Ô∏è Tasdiqlash</div><button class="modal-close" onclick="closeModal('confirm-modal')">√ó</button></div><div class="modal-body"><p id="confirm-message">Ishonchingiz komilmi?</p></div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('confirm-modal')">Bekor</button><button class="btn btn-danger" id="confirm-btn">Tasdiqlash</button></div></div></div>
    <div class="modal-overlay" id="delete-all-modal"><div class="modal" style="max-width:450px"><div class="modal-header"><div class="modal-title">üóëÔ∏è Barcha operatsiyalarni o'chirish</div><button class="modal-close" onclick="closeModal('delete-all-modal')">√ó</button></div><div class="modal-body"><div style="background:rgba(239,68,68,0.1);border:2px solid rgba(239,68,68,0.3);border-radius:var(--radius-md);padding:15px;margin-bottom:15px"><p style="color:var(--accent-red);font-weight:700;margin-bottom:10px">‚ö†Ô∏è OGOHLANTIRISH!</p><p style="font-size:0.8rem;color:var(--text-medium)">Bu amal quyidagilarni o'chirib yuboradi:</p><ul style="font-size:0.75rem;color:var(--text-medium);margin:10px 0 0 20px"><li>Barcha partiyalar</li><li>Barcha operatsiyalar (kirim, chiqim)</li><li>Barcha NG yozuvlar</li><li>Barcha sertifikatlar</li></ul><p style="font-size:0.75rem;color:var(--accent-green);margin-top:10px">‚úÖ O'chirishdan oldin Excel fayl avtomatik yuklab olinadi</p></div><p style="font-size:0.8rem;margin-bottom:10px">Tasdiqlash uchun quyidagi matnni kiriting:</p><p style="font-family:'Space Mono',monospace;font-size:0.85rem;font-weight:700;color:var(--accent-red);background:var(--bg-input);padding:10px;border-radius:var(--radius-sm);text-align:center;margin-bottom:10px">o'chirib yuborilsin</p><input type="text" class="form-control" id="delete-all-confirm" placeholder="Yuqoridagi matnni kiriting..." autocomplete="off"></div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('delete-all-modal')">Bekor</button><button class="btn btn-danger" onclick="executeDeleteAll()">üóëÔ∏è O'chirib yuborish</button></div></div></div>
    <div class="modal-overlay" id="operation-edit-modal"><div class="modal" style="max-width:400px"><div class="modal-header"><div class="modal-title">‚úèÔ∏è Operatsiya tahrirlash</div><button class="modal-close" onclick="closeModal('operation-edit-modal')">√ó</button></div><div class="modal-body"><input type="hidden" id="edit-op-id"><div class="form-group"><label class="form-label">Turi</label><input type="text" class="form-control" id="edit-op-type" readonly></div><div class="form-group"><label class="form-label">Miqdor</label><input type="number" class="form-control" id="edit-op-qty" step="0.000001" min="0.000001" required></div><div class="form-group"><label class="form-label">Sana</label><input type="date" class="form-control" id="edit-op-date" required></div><div class="form-group"><label class="form-label">Izoh</label><input type="text" class="form-control" id="edit-op-note"></div></div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('operation-edit-modal')">Bekor</button><button class="btn btn-primary" onclick="saveOperationEdit()">üíæ Saqlash</button></div></div></div>
    
    <!-- ULTRA MODERN PRESENTATION -->
    <div class="presentation-overlay" id="presentation-overlay">
        <div class="presentation-particles" id="presentation-particles"></div>
        <div class="presentation-header">
            <div class="presentation-title"><span class="byd-badge">üöó BYD</span> Kimyoviy Materiallar - Hisobot</div>
            <div class="presentation-controls">
                <span id="slide-counter">1 / 10</span>
                <button class="pres-btn" onclick="prevSlide()">‚¨ÖÔ∏è Oldingi</button>
                <button class="pres-btn" onclick="nextSlide()">Keyingi ‚û°Ô∏è</button>
                <button class="pres-btn danger" onclick="endPresentation()">‚úñÔ∏è Yopish</button>
            </div>
        </div>
        <div class="presentation-content" id="presentation-content"></div>
        <div class="presentation-nav" id="presentation-nav"></div>
    </div>
    
    <script>
        let currentUser=null,appData={materials:[],partiyalar:[],operations:[],certificates:[],ngRecords:[]},charts={},currentSlide=0,historyPage=1,selectedPartiya={},presentationStats=null;
        let dateFilter={startDate:null,endDate:null};
        let renewSelection={partiyaId:null,ngId:null};
        const totalSlides=10,historyPerPage=20;
        const precise=n=>Math.round((parseFloat(n)||0)*1000000)/1000000;
        const formatDate=d=>d?new Date(d).toLocaleDateString('uz-UZ'):'-';
        const formatNum=n=>{const v=precise(n);return v===0?'0':v.toLocaleString('uz-UZ',{minimumFractionDigits:0,maximumFractionDigits:6})};
        const getToday=()=>new Date().toISOString().split('T')[0];
        const pct=(v,t)=>t>0?Math.round(v/t*100):0;
        
        async function api(url,opt={}){const r=await fetch(url,{...opt,headers:{'Content-Type':'application/json',...opt.headers}});const d=await r.json();if(!r.ok)throw new Error(d.error||'Xatolik');return d}
        async function apiForm(url,fd){const r=await fetch(url,{method:'POST',body:fd});const d=await r.json();if(!r.ok)throw new Error(d.error||'Xatolik');return d}
        
        function showToast(msg,type='success'){const c=document.getElementById('toast-container');const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};const t=document.createElement('div');t.className='toast toast-'+type;t.innerHTML='<span>'+icons[type]+'</span><span class="toast-message">'+msg+'</span>';c.appendChild(t);setTimeout(()=>t.remove(),3000)}
        function openModal(id){document.getElementById(id).classList.add('active')}
        function closeModal(id){document.getElementById(id).classList.remove('active')}
        function updateDateTime(){const now=new Date();const days=['Yakshanba','Dushanba','Seshanba','Chorshanba','Payshanba','Juma','Shanba'];const months=['Yanvar','Fevral','Mart','Aprel','May','Iyun','Iyul','Avg','Sen','Okt','Noy','Dek'];document.getElementById('current-date').textContent=now.getDate()+' '+months[now.getMonth()]+', '+days[now.getDay()];document.getElementById('current-time').textContent=now.toLocaleTimeString('uz-UZ',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
        
        function setDateRange(range,btn){document.querySelectorAll('.quick-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');const today=new Date();let start,end;switch(range){case'today':start=end=getToday();break;case'week':start=new Date(today.getTime()-6*24*60*60*1000).toISOString().split('T')[0];end=getToday();break;case'month':start=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];end=getToday();break;case'year':start=new Date(today.getFullYear(),0,1).toISOString().split('T')[0];end=getToday();break;default:start=null;end=null}document.getElementById('filter-start-date').value=start||'';document.getElementById('filter-end-date').value=end||'';dateFilter={startDate:start,endDate:end};renderAll()}
        function applyDateFilter(){document.querySelectorAll('.quick-btn').forEach(b=>b.classList.remove('active'));dateFilter.startDate=document.getElementById('filter-start-date').value||null;dateFilter.endDate=document.getElementById('filter-end-date').value||null;renderAll()}
        function getFilteredOperations(){if(!dateFilter.startDate||!dateFilter.endDate)return appData.operations;return appData.operations.filter(op=>op.date>=dateFilter.startDate&&op.date<=dateFilter.endDate)}
        
        async function checkAuth(){try{const d=await api('/api/me');currentUser=d.user;showApp()}catch(e){showLogin()}}
        async function handleLogin(e){e.preventDefault();const btn=document.getElementById('login-btn'),err=document.getElementById('login-error');btn.disabled=true;btn.textContent='‚è≥ Tekshirilmoqda...';err.classList.remove('show');try{const d=await api('/api/login',{method:'POST',body:JSON.stringify({username:document.getElementById('login-username').value,password:document.getElementById('login-password').value})});currentUser=d.user;document.getElementById('login-password').value='';showApp()}catch(e){err.textContent=e.message;err.classList.add('show');document.getElementById('login-password').value=''}finally{btn.disabled=false;btn.textContent='üöÄ Kirish'}}
        async function handleLogout(){try{await api('/api/logout',{method:'POST'})}catch(e){}currentUser=null;document.getElementById('login-username').value='';document.getElementById('login-password').value='';showLogin()}
        function showLogin(){document.getElementById('login-page').classList.remove('hidden');document.getElementById('app-wrapper').classList.remove('active');document.getElementById('login-username').value='';document.getElementById('login-password').value=''}
        function showApp(){document.getElementById('login-page').classList.add('hidden');document.getElementById('app-wrapper').classList.add('active');document.getElementById('user-info').className='user-info '+currentUser.role;document.getElementById('current-user').textContent=currentUser.username;const isAdmin=currentUser.role==='admin';document.querySelectorAll('.admin-only').forEach(el=>el.classList.toggle('hidden',!isAdmin));document.getElementById('viewer-notice').classList.toggle('hidden',isAdmin);document.getElementById('new-login').value=currentUser.username;loadAllData();updateDateTime();setInterval(updateDateTime,1000)}
        
        async function loadAllData(){try{const[materials,partiyalar,operations,ngRecords,certificates]=await Promise.all([api('/api/materials'),api('/api/partiyalar'),api('/api/operations'),api('/api/ng-records'),api('/api/certificates')]);appData={materials,partiyalar:partiyalar.sort((a,b)=>a.id-b.id),operations,ngRecords,certificates};renderAll()}catch(e){showToast('Ma\'lumotlarni yuklashda xatolik','error');console.error(e)}}
        function renderAll(){updateStats();updateCharts();updateRecentActivity();renderMaterials();populateSelects();renderHistory();renderNGList();renderReports();renderCertificates();updateSettingsInfo();renderExpiringSoon();document.getElementById('filter-ops-count').textContent=getFilteredOperations().length+' operatsiya'}
        
        function getPartiyaIndex(materialId,partiyaId){const matParts=appData.partiyalar.filter(p=>p.materialId===materialId).sort((a,b)=>a.id-b.id);return matParts.findIndex(p=>p.id===partiyaId)+1}
        function getMaterialQty(id){return appData.partiyalar.filter(p=>p.materialId===id).reduce((s,p)=>s+precise(p.currentQty||0),0)}
        function getMaterialKirim(id){const ops=getFilteredOperations();return ops.filter(o=>o.materialId===id&&o.type==='kirim').reduce((s,o)=>s+precise(o.qty),0)}
        function getMaterialChiqim(id){const ops=getFilteredOperations();return ops.filter(o=>o.materialId===id&&o.type==='chiqim').reduce((s,o)=>s+precise(o.qty),0)}
        function getMaterialNG(id){return appData.ngRecords.filter(n=>n.materialId===id&&!n.restored).reduce((s,n)=>s+precise(n.qty),0)}
        
        // TO'G'IRLANGAN STATUS FUNKSIYASI
        function getMaterialStatus(m){
            const q=getMaterialQty(m.id);
            const minQty=m.minQty||10;
            const today=getToday();
            const parts=appData.partiyalar.filter(p=>p.materialId===m.id&&p.currentQty>0);
            const hasRenewed=parts.some(p=>p.renewed);
            const hasExpired=parts.some(p=>p.expiryEnd&&p.expiryEnd<today&&!p.renewed);
            // NG bilan muddat o'tgan
            const ngExpired=appData.ngRecords.filter(n=>n.materialId===m.id&&!n.restored&&n.reason==='expired');
            
            if(hasRenewed)return{status:'renewed',label:'Yangilangan',class:'renewed'};
            if(hasExpired||ngExpired.length>0)return{status:'expired',label:'Muddat O\'tgan',class:'danger'};
            if(q<=0)return{status:'critical',label:'Tugagan',class:'danger'};
            if(q<=minQty)return{status:'critical',label:'Kritik (Min: '+minQty+')',class:'danger'};
            if(q<=minQty*1.5)return{status:'warning',label:'Kam (Min: '+minQty+')',class:'warning'};
            return{status:'ok',label:'Yetarli',class:'success'};
        }
        
        // TO'G'IRLANGAN STATISTIKA
        function updateStats(){
            const total=appData.materials.length;
            const today=getToday();
            let s={ok:0,warning:0,critical:0,expired:0,renewed:0,ng:0};
            const activeNG=appData.ngRecords.filter(n=>!n.restored);
            s.ng=activeNG.length;
            
            appData.materials.forEach(m=>{
                const q=getMaterialQty(m.id);
                const minQty=m.minQty||10;
                const parts=appData.partiyalar.filter(p=>p.materialId===m.id&&p.currentQty>0);
                const hasRenewed=parts.some(p=>p.renewed);
                const hasExpired=parts.some(p=>p.expiryEnd&&p.expiryEnd<today&&!p.renewed);
                // NG dan muddat o'tgan ham expired ga kiradi
                const ngExpired=appData.ngRecords.filter(n=>n.materialId===m.id&&!n.restored&&n.reason==='expired');
                
                if(hasRenewed){s.renewed++}
                else if(hasExpired||ngExpired.length>0){s.expired++}
                else if(q<=0||q<=minQty){s.critical++}
                else if(q<=minQty*1.5){s.warning++}
                else{s.ok++}
            });
            
            const filteredOps=getFilteredOperations();
            const totalKirim=filteredOps.filter(o=>o.type==='kirim').reduce((sum,o)=>sum+precise(o.qty),0);
            const totalChiqim=filteredOps.filter(o=>o.type==='chiqim').reduce((sum,o)=>sum+precise(o.qty),0);
            const ngQty=activeNG.reduce((sum,n)=>sum+precise(n.qty),0);
            
            document.getElementById('stat-total').textContent=total;
            document.getElementById('stat-ok').textContent=s.ok;
            document.getElementById('stat-ok-pct').textContent=pct(s.ok,total)+'%';
            document.getElementById('stat-warning').textContent=s.warning;
            document.getElementById('stat-warning-pct').textContent=pct(s.warning,total)+'%';
            document.getElementById('stat-critical').textContent=s.critical;
            document.getElementById('stat-critical-pct').textContent=pct(s.critical,total)+'%';
            document.getElementById('stat-expired').textContent=s.expired;
            document.getElementById('stat-expired-pct').textContent=pct(s.expired,total)+'%';
            document.getElementById('stat-renewed').textContent=s.renewed;
            document.getElementById('stat-renewed-pct').textContent=pct(s.renewed,total)+'%';
            document.getElementById('stat-ng').textContent=s.ng;
            document.getElementById('stat-ng-pct').textContent=formatNum(ngQty);
            document.getElementById('stat-kirim').textContent=formatNum(totalKirim);
            document.getElementById('stat-chiqim').textContent=formatNum(totalChiqim);
            
            const totalFlow=totalKirim+totalChiqim;
            document.getElementById('kirim-percent').textContent=pct(totalKirim,totalFlow)+'%';
            document.getElementById('chiqim-percent').textContent=pct(totalChiqim,totalFlow)+'%';
        }
        
        function updateCharts(){
        const filteredOps=getFilteredOperations();
        const kirimData=appData.materials.map(m=>({code:m.code,v:filteredOps.filter(o=>o.materialId===m.id&&o.type==='kirim').reduce((s,o)=>s+precise(o.qty),0)})).filter(d=>d.v>0).sort((a,b)=>b.v-a.v).slice(0,10);
        if(charts.kirim)charts.kirim.destroy();
        const kirimCtx=document.getElementById('kirimChart');
        if(kirimCtx&&kirimData.length>0){charts.kirim=new Chart(kirimCtx,{type:'bar',data:{labels:kirimData.map(d=>d.code),datasets:[{label:'Kirim',data:kirimData.map(d=>d.v),backgroundColor:'#10b981',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:8}}},y:{grid:{color:'rgba(0,0,0,0.05)'}}}}})}
        const chiqimData=appData.materials.map(m=>({code:m.code,v:filteredOps.filter(o=>o.materialId===m.id&&o.type==='chiqim').reduce((s,o)=>s+precise(o.qty),0)})).filter(d=>d.v>0).sort((a,b)=>b.v-a.v).slice(0,10);
        if(charts.chiqim)charts.chiqim.destroy();
        const chiqimCtx=document.getElementById('chiqimChart');
        if(chiqimCtx&&chiqimData.length>0){charts.chiqim=new Chart(chiqimCtx,{type:'bar',data:{labels:chiqimData.map(d=>d.code),datasets:[{label:'Chiqim',data:chiqimData.map(d=>d.v),backgroundColor:'#ef4444',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:8}}},y:{grid:{color:'rgba(0,0,0,0.05)'}}}}})}
        const months=[],kirim=[],chiqim=[],ngData=[];
        for(let i=5;i>=0;i--){const d=new Date();d.setMonth(d.getMonth()-i);const k=d.toISOString().slice(0,7);months.push(d.toLocaleDateString('uz-UZ',{month:'short'}));const ops=appData.operations.filter(o=>o.date?.startsWith(k));kirim.push(ops.filter(o=>o.type==='kirim').reduce((s,o)=>s+precise(o.qty),0));chiqim.push(ops.filter(o=>o.type==='chiqim').reduce((s,o)=>s+precise(o.qty),0));const ngOps=ops.filter(o=>o.type==='ng');const ngQtyMonth=ngOps.reduce((s,o)=>{const ngRec=appData.ngRecords.find(n=>n.materialId===o.materialId&&n.partiyaId===o.partiyaId&&!n.restored);return s+(ngRec?o.qty:0)},0);ngData.push(ngQtyMonth)}
        if(charts.monthly)charts.monthly.destroy();
        const monthlyCtx=document.getElementById('monthlyChart');
        if(monthlyCtx){charts.monthly=new Chart(monthlyCtx,{type:'bar',data:{labels:months,datasets:[{label:'Kirim',data:kirim,backgroundColor:'#10b981',borderRadius:2},{label:'Chiqim',data:chiqim,backgroundColor:'#ef4444',borderRadius:2},{label:'NG',data:ngData,backgroundColor:'#f59e0b',borderRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9}}}},scales:{x:{grid:{display:false}},y:{grid:{color:'rgba(0,0,0,0.05)'}}}}})}
        const cats={};const catLabels={oil:'Moy',chemical:'Kimyoviy',gas:'Gaz',other:'Boshqa'};
        appData.materials.forEach(m=>{const c=m.category||'other';cats[c]=(cats[c]||0)+getMaterialQty(m.id)});
        if(charts.category)charts.category.destroy();
        const catCtx=document.getElementById('categoryChart');
        if(catCtx){const catKeys=Object.keys(cats);const catColors=['#0ea5e9','#8b5cf6','#06b6d4','#f59e0b'];charts.category=new Chart(catCtx,{type:'doughnut',data:{labels:catKeys.map(k=>catLabels[k]||k),datasets:[{data:Object.values(cats),backgroundColor:catColors.slice(0,catKeys.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9}}}}}})}
        }
        function updateRecentActivity(){const tbody=document.getElementById('recent-activity');const filteredOps=getFilteredOperations();const recent=filteredOps.sort((a,b)=>b.id-a.id).slice(0,10);const types={kirim:'üì• Kirim',chiqim:'üì§ Chiqim',ng:'‚ö†Ô∏è NG',renew:'üîÑ Yangilash',initial:'üì¶ Qoldiq',restore:'‚ôªÔ∏è Qaytarish'};tbody.innerHTML=recent.map(op=>{const m=appData.materials.find(x=>x.id===op.materialId);return '<tr><td>'+formatDate(op.date)+'</td><td><span class="material-code">'+(m?.code||'-')+'</span></td><td><span class="history-type '+op.type+'">'+(types[op.type]||op.type)+'</span></td><td><strong>'+formatNum(op.qty)+'</strong></td><td style="font-size:0.7rem">'+(op.note||'-')+'</td></tr>'}).join('')||'<tr><td colspan="5"><div class="empty-state"><p>Tarix yo\'q</p></div></td></tr>'}
        
        function renderMaterials(){const tbody=document.getElementById('materials-table');const search=(document.getElementById('search-materials')?.value||'').toLowerCase();const statusF=document.getElementById('filter-status')?.value||'';let filtered=appData.materials.filter(m=>{if(search&&!m.code.toLowerCase().includes(search)&&!m.name.toLowerCase().includes(search))return false;if(statusF){const st=getMaterialStatus(m);if(st.status!==statusF)return false}return true});document.getElementById('materials-count').textContent=filtered.length;if(filtered.length===0){tbody.innerHTML='<tr><td colspan="11"><div class="empty-state"><div class="icon">üì¶</div><h3>Material yo\'q</h3></div></td></tr>';return}const isAdmin=currentUser?.role==='admin';tbody.innerHTML=filtered.map((m,idx)=>{const q=getMaterialQty(m.id),ki=getMaterialKirim(m.id),ch=getMaterialChiqim(m.id),ng=getMaterialNG(m.id),st=getMaterialStatus(m);return '<tr class="clickable" ondblclick="showMaterialHistory('+m.id+')"><td>'+(idx+1)+'</td><td><span class="material-code">'+m.code+'</span></td><td>'+m.name+'</td><td>'+m.unit+'</td><td style="color:var(--accent-orange)">'+(m.minQty||10)+'</td><td style="color:var(--accent-green)">'+formatNum(ki)+'</td><td style="color:var(--accent-red)">'+formatNum(ch)+'</td><td style="color:#b45309">'+formatNum(ng)+'</td><td><strong>'+formatNum(q)+'</strong></td><td><span class="badge badge-'+st.class+'">'+st.label+'</span></td><td>'+(isAdmin?'<button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();editMaterial('+m.id+')">‚úèÔ∏è</button><button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();deleteMaterial('+m.id+')">üóëÔ∏è</button>':'<button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();showMaterialHistory('+m.id+')">üëÅÔ∏è</button>')+'</td></tr>'}).join('')}
        
        function openMaterialModal(){document.getElementById('form-material').reset();document.getElementById('material-id').value='';document.getElementById('material-modal-title').textContent='Yangi Material';document.getElementById('material-unit').value='litr';document.getElementById('material-min').value='10';openModal('material-modal')}
        function editMaterial(id){const m=appData.materials.find(x=>x.id===id);if(!m)return;document.getElementById('material-modal-title').textContent='Tahrirlash';document.getElementById('material-id').value=m.id;document.getElementById('material-code').value=m.code;document.getElementById('material-name').value=m.name;document.getElementById('material-unit').value=m.unit;document.getElementById('material-min').value=m.minQty||10;document.getElementById('material-expiry').value=m.expiryMonths||12;document.getElementById('material-cat').value=m.category||'oil';openModal('material-modal')}
        async function saveMaterial(e){e.preventDefault();const id=document.getElementById('material-id').value;const data={code:document.getElementById('material-code').value.trim(),name:document.getElementById('material-name').value.trim(),unit:document.getElementById('material-unit').value.trim()||'litr',minQty:parseFloat(document.getElementById('material-min').value)||10,expiryMonths:parseInt(document.getElementById('material-expiry').value)||12,category:document.getElementById('material-cat').value};try{if(id){await api('/api/materials/'+id,{method:'PUT',body:JSON.stringify(data)})}else{await api('/api/materials',{method:'POST',body:JSON.stringify(data)})}closeModal('material-modal');await loadAllData();showToast('Saqlandi!')}catch(e){showToast(e.message,'error')}}
        async function deleteMaterial(id){const m=appData.materials.find(x=>x.id===id);document.getElementById('confirm-message').textContent='"'+m?.code+'" ni o\'chirmoqchimisiz?';document.getElementById('confirm-btn').onclick=async()=>{try{await api('/api/materials/'+id,{method:'DELETE'});closeModal('confirm-modal');await loadAllData();showToast('O\'chirildi!')}catch(e){showToast(e.message,'error')}};openModal('confirm-modal')}
        
        function showMaterialHistory(id,filter='all'){const m=appData.materials.find(x=>x.id===id);if(!m)return;window.currentHistoryMaterialId=id;const allOps=appData.operations.filter(o=>o.materialId===id).sort((a,b)=>b.id-a.id);const parts=appData.partiyalar.filter(p=>p.materialId===id).sort((a,b)=>a.id-b.id);const certs=appData.certificates.filter(c=>c.materialId===id);const kirim=getMaterialKirim(id),chiqim=getMaterialChiqim(id),ng=getMaterialNG(id),qoldiq=getMaterialQty(id);
        let ops=allOps;
        if(filter==='kirim')ops=allOps.filter(o=>o.type==='kirim'||o.type==='initial');
        else if(filter==='chiqim')ops=allOps.filter(o=>o.type==='chiqim');
        else if(filter==='ng')ops=allOps.filter(o=>o.type==='ng');
        else if(filter==='restore')ops=allOps.filter(o=>o.type==='restore'||o.type==='renew');
        
        let html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Min Qoldiq</div><div class="detail-value" style="color:var(--accent-orange)">'+(m.minQty||10)+'</div></div><div class="detail-item"><div class="detail-label">Kirim</div><div class="detail-value" style="color:var(--accent-green)">'+formatNum(kirim)+'</div></div><div class="detail-item"><div class="detail-label">Chiqim</div><div class="detail-value" style="color:var(--accent-red)">'+formatNum(chiqim)+'</div></div><div class="detail-item"><div class="detail-label">NG</div><div class="detail-value" style="color:#b45309">'+formatNum(ng)+'</div></div><div class="detail-item"><div class="detail-label">Qoldiq</div><div class="detail-value" style="font-size:1.1rem">'+formatNum(qoldiq)+'</div></div></div>';
        if(certs.length>0){html+='<h4 style="margin:14px 0 8px;font-weight:700;color:var(--accent-cyan)">üìú Sertifikatlar</h4>';certs.forEach(c=>{html+='<div class="cert-card"><div class="cert-card-header"><div class="cert-card-icon">üìú</div><div class="cert-card-info"><h4>'+c.fileName+'</h4><p>Yangi muddat: '+formatDate(c.newExpiryEnd)+'</p></div></div><div class="cert-actions"><button class="btn btn-info btn-xs" onclick="viewCertificate('+c.id+')">üëÅÔ∏è</button><button class="btn btn-cyan btn-xs" onclick="downloadCertificate('+c.id+')">üì•</button></div></div>'})}
        html+='<h4 style="margin:14px 0 8px;font-weight:700">üì¶ Partiyalar</h4>';
        if(parts.length>0){html+='<div class="history-scroll" style="max-height:150px"><table><thead><tr><th>Partiya</th><th>Muddat</th><th>Boshl.</th><th>Qoldiq</th><th>Status</th></tr></thead><tbody>';const today=getToday();parts.forEach((p,idx)=>{let stC='success',stL='OK';if(p.renewed){stC='renewed';stL='Yangilangan'}else if(p.expiryEnd&&p.expiryEnd<today){stC='danger';stL='O\'tgan'}html+='<tr><td><strong>P'+(idx+1)+'</strong></td><td>'+formatDate(p.expiryEnd)+'</td><td>'+formatNum(p.initialQty)+'</td><td><strong>'+formatNum(p.currentQty)+'</strong></td><td><span class="badge badge-'+stC+'">'+stL+'</span></td></tr>'});html+='</tbody></table></div>'}
        html+='<h4 style="margin:14px 0 8px;font-weight:700">üìã Tarix</h4>';
        html+='<div class="history-filter-btns" style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">';
        html+='<button class="btn btn-sm '+(filter==='all'?'btn-primary':'btn-ghost')+'" onclick="showMaterialHistory('+id+',\'all\')">Jami ('+allOps.length+')</button>';
        html+='<button class="btn btn-sm '+(filter==='kirim'?'btn-success':'btn-ghost')+'" onclick="showMaterialHistory('+id+',\'kirim\')">üì• Kirim</button>';
        html+='<button class="btn btn-sm '+(filter==='chiqim'?'btn-danger':'btn-ghost')+'" onclick="showMaterialHistory('+id+',\'chiqim\')">üì§ Chiqim</button>';
        html+='<button class="btn btn-sm '+(filter==='ng'?'btn-warning':'btn-ghost')+'" onclick="showMaterialHistory('+id+',\'ng\')">‚ö†Ô∏è NG</button>';
        html+='<button class="btn btn-sm '+(filter==='restore'?'btn-cyan':'btn-ghost')+'" onclick="showMaterialHistory('+id+',\'restore\')">‚ôªÔ∏è Qaytarilgan</button>';
        html+='</div>';
        const isAdmin=currentUser?.role==='admin';
        if(ops.length>0){html+='<div class="history-scroll"><table><thead><tr><th>ID</th><th>Sana</th><th>Turi</th><th>Partiya</th><th>Miqdor</th><th>Izoh</th>'+(isAdmin?'<th>Amal</th>':'')+'</tr></thead><tbody>';const types={kirim:{i:'üì•',l:'Kirim'},chiqim:{i:'üì§',l:'Chiqim'},ng:{i:'‚ö†Ô∏è',l:'NG'},renew:{i:'üîÑ',l:'Yangilash'},restore:{i:'‚ôªÔ∏è',l:'Qaytarish'},initial:{i:'üì¶',l:'Qoldiq'}};ops.slice(0,50).forEach(op=>{const t=types[op.type]||types.kirim;const pIdx=getPartiyaIndex(id,op.partiyaId);html+='<tr><td>#'+op.id+'</td><td>'+formatDate(op.date)+'</td><td><span class="history-type '+op.type+'">'+t.i+' '+t.l+'</span></td><td>P'+(pIdx||'-')+'</td><td><strong>'+formatNum(op.qty)+'</strong></td><td style="font-size:0.7rem">'+(op.note||'-')+'</td>'+(isAdmin?'<td><button class="btn btn-ghost btn-xs" onclick="editOperation('+op.id+')">‚úèÔ∏è</button><button class="btn btn-ghost btn-xs" onclick="deleteOperation('+op.id+')">üóëÔ∏è</button></td>':'')+'</tr>'});html+='</tbody></table></div>'}else{html+='<div class="empty-state"><p>Tarix yo\'q</p></div>'}
        document.getElementById('history-modal-title').textContent=m.code+' - '+m.name;document.getElementById('history-modal-content').innerHTML=html;openModal('history-modal')}
        function viewCertificate(id){document.getElementById('cert-iframe').src='/api/certificates/'+id+'/view';const c=appData.certificates.find(x=>x.id===id);document.getElementById('cert-modal-title').textContent=c?.fileName||'Sertifikat';openModal('cert-modal')}
        function downloadCertificate(id){window.open('/api/certificates/'+id+'/download','_blank')}
        
        function populateSelects(){const options=appData.materials.map(m=>'<option value="'+m.id+'">'+m.code+' - '+m.name+'</option>').join('');const emptyOption='<option value="">Tanlang...</option>';['kirim-material','chiqim-material','ng-material','renew-material'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=emptyOption+options});const today=getToday();['kirim-date','chiqim-date','kirim-start'].forEach(id=>{const el=document.getElementById(id);if(el&&!el.value)el.value=today});selectedPartiya={};renewSelection={partiyaId:null,ngId:null}}
        
        function loadPartiyalar(type){const materialId=document.getElementById(type+'-material').value;const container=document.getElementById(type+'-partiya-cont');const list=document.getElementById(type+'-partiya-list');if(!materialId){container.style.display='none';return}const matParts=appData.partiyalar.filter(p=>p.materialId==materialId).sort((a,b)=>a.id-b.id);const parts=matParts.filter(p=>p.currentQty>0);if(!parts.length){container.style.display='none';return}container.style.display='block';const today=getToday();list.innerHTML=parts.map(p=>{const pIdx=matParts.indexOf(p)+1;let cls='partiya-item';if(p.expiryEnd&&p.expiryEnd<today&&!p.renewed)cls+=' expired';if(selectedPartiya[type]===p.id)cls+=' selected';return '<div class="'+cls+'" onclick="selectPartiya(\''+type+'\','+p.id+')"><div class="partiya-info"><strong>P'+pIdx+'</strong><span>'+formatDate(p.expiryEnd)+' '+(p.renewed?'üîÑ':'')+'</span></div><div class="partiya-qty">'+formatNum(p.currentQty)+'</div></div>'}).join('');if(type==='chiqim'&&parts.length&&!selectedPartiya[type])selectPartiya(type,parts[0].id)}
        function selectPartiya(type,id){selectedPartiya[type]=id;loadPartiyalar(type)}
        
        function loadRenewOptions(){const materialId=document.getElementById('renew-material').value;const container=document.getElementById('renew-partiya-cont');const list=document.getElementById('renew-partiya-list');const ngSection=document.getElementById('renew-ng-section');const ngList=document.getElementById('renew-ng-list');if(!materialId){container.style.display='none';ngSection.style.display='none';renewSelection={partiyaId:null,ngId:null};return}const matParts=appData.partiyalar.filter(p=>p.materialId==materialId).sort((a,b)=>a.id-b.id);const parts=matParts.filter(p=>p.currentQty>0);const today=getToday();const ngItems=appData.ngRecords.filter(n=>n.materialId==materialId&&!n.restored&&n.reason==='expired');if(parts.length>0){container.style.display='block';list.innerHTML=parts.map(p=>{const pIdx=matParts.indexOf(p)+1;let cls='partiya-item';if(p.expiryEnd&&p.expiryEnd<today&&!p.renewed)cls+=' expired';if(renewSelection.partiyaId===p.id&&!renewSelection.ngId)cls+=' selected';return '<div class="'+cls+'" onclick="selectRenewPartiya('+p.id+')"><div class="partiya-info"><strong>P'+pIdx+'</strong><span>Muddat: '+formatDate(p.expiryEnd)+(p.renewed?' üîÑ':'')+'</span></div><div class="partiya-qty">'+formatNum(p.currentQty)+'</div></div>'}).join('')}else{container.style.display='none'}if(ngItems.length>0){ngSection.style.display='block';ngList.innerHTML=ngItems.map(n=>{const pIdx=matParts.findIndex(p=>p.id===n.partiyaId)+1;let cls='partiya-item ng-item';if(renewSelection.ngId===n.id)cls+=' selected';return '<div class="'+cls+'" onclick="selectRenewNG('+n.id+','+n.partiyaId+')"><div class="partiya-info"><strong>NG #'+n.id+' (P'+pIdx+')</strong><span>‚ö†Ô∏è '+formatDate(n.expiryEnd)+' - Muddat o\'tgan</span></div><div class="partiya-qty" style="color:var(--accent-red)">'+formatNum(n.qty)+'</div></div>'}).join('')}else{ngSection.style.display='none'}}
        function selectRenewPartiya(id){renewSelection={partiyaId:id,ngId:null};loadRenewOptions()}
        function selectRenewNG(ngId,partiyaId){renewSelection={partiyaId:partiyaId,ngId:ngId};loadRenewOptions()}
        
        async function handleKirim(e){e.preventDefault();try{await api('/api/kirim',{method:'POST',body:JSON.stringify({materialId:parseInt(document.getElementById('kirim-material').value),qty:parseFloat(document.getElementById('kirim-qty').value),expiryStart:document.getElementById('kirim-start').value,expiryEnd:document.getElementById('kirim-end').value,date:document.getElementById('kirim-date').value,note:document.getElementById('kirim-note').value})});showToast('Kirim saqlandi!');e.target.reset();document.getElementById('kirim-date').value=getToday();document.getElementById('kirim-start').value=getToday();await loadAllData()}catch(err){showToast(err.message,'error')}}
        
        async function handleChiqim(e){e.preventDefault();const partiyaId=selectedPartiya['chiqim'];if(!partiyaId){showToast('Partiya tanlang!','warning');return}try{await api('/api/chiqim',{method:'POST',body:JSON.stringify({materialId:parseInt(document.getElementById('chiqim-material').value),partiyaId:partiyaId,qty:parseFloat(document.getElementById('chiqim-qty').value),date:document.getElementById('chiqim-date').value,note:document.getElementById('chiqim-note').value})});showToast('Chiqim saqlandi!');e.target.reset();document.getElementById('chiqim-date').value=getToday();document.getElementById('chiqim-partiya-cont').style.display='none';selectedPartiya['chiqim']=null;await loadAllData()}catch(err){showToast(err.message,'error')}}
        
        async function handleRenew(e){e.preventDefault();if(!renewSelection.partiyaId&&!renewSelection.ngId){showToast('Partiya yoki NG tanlang!','warning');return}const formData=new FormData();formData.append('materialId',document.getElementById('renew-material').value);formData.append('partiyaId',renewSelection.partiyaId||'');formData.append('expiryStart',document.getElementById('renew-start').value);formData.append('expiryEnd',document.getElementById('renew-end').value);formData.append('note',document.getElementById('renew-note').value);if(renewSelection.ngId){formData.append('ngId',renewSelection.ngId)}const certFile=document.getElementById('renew-cert').files[0];if(certFile)formData.append('certificate',certFile);try{await apiForm('/api/renew',formData);showToast(renewSelection.ngId?'NG qaytarildi va muddat yangilandi!':'Muddat yangilandi!');document.getElementById('renew-form').reset();document.getElementById('renew-partiya-cont').style.display='none';document.getElementById('renew-ng-section').style.display='none';renewSelection={partiyaId:null,ngId:null};await loadAllData()}catch(err){showToast(err.message,'error')}}
        
        async function handleNG(){const materialId=document.getElementById('ng-material').value;const partiyaId=selectedPartiya['ng'];const qty=document.getElementById('ng-qty').value;const reason=document.getElementById('ng-reason').value;if(!materialId||!partiyaId||!qty||!reason){showToast('Barcha maydonlarni to\'ldiring!','warning');return}try{await api('/api/ng',{method:'POST',body:JSON.stringify({materialId:parseInt(materialId),partiyaId,qty:parseFloat(qty),reason,note:document.getElementById('ng-note').value})});showToast('NG saqlandi!');document.getElementById('ng-material').value='';document.getElementById('ng-qty').value='';document.getElementById('ng-reason').value='';document.getElementById('ng-note').value='';document.getElementById('ng-partiya-cont').style.display='none';selectedPartiya['ng']=null;await loadAllData()}catch(err){showToast(err.message,'error')}}
        
        function renderNGList(){const container=document.getElementById('ng-list-container');const search=(document.getElementById('search-ng')?.value||'').toLowerCase();const activeNG=appData.ngRecords.filter(n=>!n.restored&&(n.materialCode?.toLowerCase().includes(search)||n.materialName?.toLowerCase().includes(search)));if(!activeNG.length){container.innerHTML='<div class="empty-state"><div class="icon">‚úÖ</div><h3>Faol NG yo\'q</h3></div>';return}const reasons={expired:'üìÖ Muddat o\'tgan',damaged:'üíî Buzilgan',quality:'üî¨ Sifatsiz'};const isAdmin=currentUser?.role==='admin';container.innerHTML=activeNG.map(n=>{const pIdx=getPartiyaIndex(n.materialId,n.partiyaId);return '<div class="ng-card"><div class="ng-card-header"><div class="ng-card-title">‚ö†Ô∏è '+n.materialCode+' - '+n.materialName+'</div><div>'+(isAdmin?'<button class="btn btn-success btn-sm" onclick="restoreFromNG('+n.id+')">‚ôªÔ∏è Qaytarish</button>':'')+'<button class="btn btn-info btn-sm" onclick="showNGDetail('+n.id+')">üëÅÔ∏è</button></div></div><div class="detail-grid"><div class="detail-item"><div class="detail-label">Miqdor</div><div class="detail-value" style="color:#b45309">'+formatNum(n.qty)+'</div></div><div class="detail-item"><div class="detail-label">Sabab</div><div class="detail-value">'+(reasons[n.reason]||n.reason)+'</div></div><div class="detail-item"><div class="detail-label">Sana</div><div class="detail-value">'+formatDate(n.date)+'</div></div><div class="detail-item"><div class="detail-label">Partiya</div><div class="detail-value">P'+pIdx+'</div></div></div></div>'}).join('')}
        
        function showNGDetail(ngId){const n=appData.ngRecords.find(x=>x.id===ngId);if(!n)return;const reasons={expired:'üìÖ Muddat o\'tgan',damaged:'üíî Buzilgan',quality:'üî¨ Sifatsiz'};const pIdx=getPartiyaIndex(n.materialId,n.partiyaId);let html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Material</div><div class="detail-value">'+n.materialCode+'</div></div><div class="detail-item"><div class="detail-label">Nomi</div><div class="detail-value">'+n.materialName+'</div></div><div class="detail-item"><div class="detail-label">Miqdor</div><div class="detail-value" style="color:#b45309">'+formatNum(n.qty)+'</div></div><div class="detail-item"><div class="detail-label">Sabab</div><div class="detail-value">'+(reasons[n.reason]||n.reason)+'</div></div><div class="detail-item"><div class="detail-label">Partiya</div><div class="detail-value">P'+pIdx+'</div></div><div class="detail-item"><div class="detail-label">Sana</div><div class="detail-value">'+formatDate(n.date)+'</div></div></div>';if(n.note)html+='<p style="margin:10px 0;padding:8px;background:var(--bg-input);border-radius:var(--radius-sm)"><strong>Izoh:</strong> '+n.note+'</p>';if(!n.restored&&currentUser?.role==='admin')html+='<div style="margin-top:16px;text-align:center"><button class="btn btn-success" onclick="closeModal(\'ng-detail-modal\');restoreFromNG('+n.id+')">‚ôªÔ∏è Qaytarish</button></div>';document.getElementById('ng-detail-title').textContent='NG #'+n.id;document.getElementById('ng-detail-content').innerHTML=html;openModal('ng-detail-modal')}
        
        async function restoreFromNG(ngId){const n=appData.ngRecords.find(x=>x.id===ngId);if(!n||n.restored)return;document.getElementById('confirm-message').innerHTML='<strong>'+n.materialCode+'</strong> dan '+formatNum(n.qty)+' ni qaytarmoqchimisiz?';document.getElementById('confirm-btn').textContent='‚ôªÔ∏è Qaytarish';document.getElementById('confirm-btn').className='btn btn-success';document.getElementById('confirm-btn').onclick=async()=>{try{await api('/api/ng/'+ngId+'/restore',{method:'POST'});closeModal('confirm-modal');showToast('Qaytarildi!');document.getElementById('confirm-btn').textContent='Tasdiqlash';document.getElementById('confirm-btn').className='btn btn-danger';await loadAllData()}catch(e){showToast(e.message,'error')}};openModal('confirm-modal')}
        
        function renderHistory(){const tbody=document.getElementById('history-table');const search=(document.getElementById('search-history')?.value||'').toLowerCase();const typeF=document.getElementById('filter-type')?.value||'';const filteredOps=getFilteredOperations();let filtered=filteredOps.map(op=>({...op,material:appData.materials.find(m=>m.id===op.materialId)})).filter(op=>op.material&&(!search||op.material.code.toLowerCase().includes(search)||op.material.name.toLowerCase().includes(search))&&(!typeF||op.type===typeF)).sort((a,b)=>b.id-a.id);const total=filtered.length,totalPages=Math.ceil(total/historyPerPage);if(historyPage>totalPages)historyPage=1;const start=(historyPage-1)*historyPerPage,pageData=filtered.slice(start,start+historyPerPage);const isAdmin=currentUser?.role==='admin';if(pageData.length===0){tbody.innerHTML='<tr><td colspan="'+(isAdmin?8:7)+'"><div class="empty-state"><div class="icon">üìã</div><h3>Tarix yo\'q</h3></div></td></tr>';document.getElementById('history-pagination').innerHTML='';return}const types={kirim:'üì• Kirim',chiqim:'üì§ Chiqim',ng:'‚ö†Ô∏è NG',renew:'üîÑ Yangilash',initial:'üì¶ Qoldiq',restore:'‚ôªÔ∏è Qaytarish'};tbody.innerHTML=pageData.map(op=>{const pIdx=getPartiyaIndex(op.materialId,op.partiyaId);return '<tr><td><span class="material-code">#'+op.id+'</span></td><td>'+formatDate(op.date)+'</td><td><span class="material-code">'+op.material.code+'</span></td><td><span class="history-type '+op.type+'">'+(types[op.type]||op.type)+'</span></td><td>P'+(pIdx||'-')+'</td><td><strong>'+formatNum(op.qty)+'</strong></td><td style="font-size:0.7rem">'+(op.note||'-')+'</td>'+(isAdmin?'<td><button class="btn btn-ghost btn-xs" onclick="editOperation('+op.id+')">‚úèÔ∏è</button><button class="btn btn-ghost btn-xs" onclick="deleteOperation('+op.id+')">üóëÔ∏è</button></td>':'')+'</tr>'}).join('');if(totalPages<=1){document.getElementById('history-pagination').innerHTML='';return}let pHtml='<button '+(historyPage===1?'disabled':'')+' onclick="goHistoryPage('+(historyPage-1)+')">‚¨ÖÔ∏è</button>';for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=historyPage-2&&i<=historyPage+2)){pHtml+='<button class="'+(i===historyPage?'active':'')+'" onclick="goHistoryPage('+i+')">'+i+'</button>'}else if(i===historyPage-3||i===historyPage+3){pHtml+='<span>...</span>'}}pHtml+='<button '+(historyPage===totalPages?'disabled':'')+' onclick="goHistoryPage('+(historyPage+1)+')">‚û°Ô∏è</button>';document.getElementById('history-pagination').innerHTML=pHtml}
        function goHistoryPage(p){historyPage=p;renderHistory()}
        
        function renderReports(){const summaryTable=document.getElementById('summary-table');summaryTable.innerHTML=appData.materials.map((m,i)=>{const kirim=getMaterialKirim(m.id),chiqim=getMaterialChiqim(m.id),ng=getMaterialNG(m.id),qoldiq=getMaterialQty(m.id);return '<tr><td>'+(i+1)+'</td><td><span class="material-code">'+m.code+'</span></td><td style="color:var(--accent-green)">'+formatNum(kirim)+'</td><td style="color:var(--accent-red)">'+formatNum(chiqim)+'</td><td style="color:#b45309">'+formatNum(ng)+'</td><td><strong>'+formatNum(qoldiq)+'</strong></td></tr>'}).join('')||'<tr><td colspan="6"><div class="empty-state"><p>Ma\'lumot yo\'q</p></div></td></tr>';const expiryTable=document.getElementById('expiry-table');const expiryData=[];const today=getToday();appData.partiyalar.filter(p=>p.currentQty>0).forEach(p=>{const m=appData.materials.find(x=>x.id===p.materialId);if(m)expiryData.push({...p,material:m})});expiryData.sort((a,b)=>new Date(a.expiryEnd||'9999')-new Date(b.expiryEnd||'9999'));expiryTable.innerHTML=expiryData.slice(0,50).map(p=>{let stC='success',stL='OK';if(p.renewed){stC='renewed';stL='Yangilangan'}else if(p.expiryEnd&&p.expiryEnd<today){stC='danger';stL='O\'tgan'}const pIdx=getPartiyaIndex(p.materialId,p.id);return '<tr><td><span class="material-code">'+p.material.code+'</span></td><td>P'+pIdx+'</td><td>'+formatDate(p.expiryEnd)+'</td><td><strong>'+formatNum(p.currentQty)+'</strong></td><td><span class="badge badge-'+stC+'">'+stL+'</span></td></tr>'}).join('')||'<tr><td colspan="5"><div class="empty-state"><p>Ma\'lumot yo\'q</p></div></td></tr>'}
        
        function renderCertificates(){const container=document.getElementById('certificates-list');if(!appData.certificates.length){container.innerHTML='<div class="empty-state"><div class="icon">üìú</div><h3>Sertifikatlar yo\'q</h3></div>';return}container.innerHTML=appData.certificates.map(c=>'<div class="cert-card"><div class="cert-card-header"><div class="cert-card-icon">üìú</div><div class="cert-card-info"><h4>'+c.materialCode+' - '+c.materialName+'</h4><p>'+c.fileName+' | Yangi muddat: '+formatDate(c.newExpiryEnd)+'</p></div></div><div class="cert-actions"><button class="btn btn-info btn-sm" onclick="viewCertificate('+c.id+')">üëÅÔ∏è Ko\'rish</button><button class="btn btn-cyan btn-sm" onclick="downloadCertificate('+c.id+')">üì• Yuklash</button></div></div>').join('')}
        
        function showStatDetail(type){
            const titles={total:'üì¶ Jami Materiallar',ok:'‚úÖ Yetarli Materiallar',warning:'‚ö†Ô∏è Kam Materiallar',critical:'üö® Kritik Materiallar',expired:'‚ùå Muddat O\'tgan',renewed:'üîÑ Yangilangan',ng:'üö´ NG Materiallar',kirim:'üì• Jami Kirim',chiqim:'üì§ Jami Chiqim'};
            const filteredOps=getFilteredOperations();
            let mats=[];let html='';
            
            if(type==='ng'){
                const activeNG=appData.ngRecords.filter(n=>!n.restored);
                const totalQty=activeNG.reduce((s,n)=>s+precise(n.qty),0);
                html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Jami NG</div><div class="detail-value" style="color:#b45309">'+activeNG.length+'</div></div><div class="detail-item"><div class="detail-label">Jami Miqdor</div><div class="detail-value" style="color:#b45309">'+formatNum(totalQty)+'</div></div></div>';
                if(activeNG.length>0){
                    const reasons={expired:'Muddat o\'tgan',damaged:'Buzilgan',quality:'Sifatsiz'};
                    html+='<h4 style="margin:14px 0 8px;font-weight:700">üìã NG Ro\'yxati</h4><div class="history-scroll"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Miqdor</th><th>Sabab</th><th>Sana</th></tr></thead><tbody>';
                    activeNG.forEach((n,i)=>{html+='<tr><td>'+(i+1)+'</td><td><span class="material-code">'+n.materialCode+'</span></td><td>'+n.materialName+'</td><td style="color:#b45309"><strong>'+formatNum(n.qty)+'</strong></td><td>'+(reasons[n.reason]||n.reason)+'</td><td>'+formatDate(n.date)+'</td></tr>'});
                    html+='</tbody></table></div>';
                }
            }else if(type==='kirim'){
                const ops=filteredOps.filter(o=>o.type==='kirim');
                const total=ops.reduce((s,o)=>s+precise(o.qty),0);
                html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Jami Kirim</div><div class="detail-value" style="color:var(--accent-green)">'+formatNum(total)+'</div></div><div class="detail-item"><div class="detail-label">Operatsiyalar</div><div class="detail-value">'+ops.length+'</div></div></div>';
                if(ops.length>0){html+='<h4 style="margin:14px 0 8px;font-weight:700">üìã Kirim operatsiyalari</h4><div class="history-scroll"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Miqdor</th><th>Sana</th></tr></thead><tbody>';ops.slice(0,50).forEach((op,i)=>{const m=appData.materials.find(x=>x.id===op.materialId);html+='<tr><td>'+(i+1)+'</td><td><span class="material-code">'+(m?.code||'-')+'</span></td><td>'+(m?.name||'-')+'</td><td style="color:var(--accent-green)"><strong>'+formatNum(op.qty)+'</strong></td><td>'+formatDate(op.date)+'</td></tr>'});html+='</tbody></table></div>'}
            }else if(type==='chiqim'){
                const ops=filteredOps.filter(o=>o.type==='chiqim');
                const total=ops.reduce((s,o)=>s+precise(o.qty),0);
                html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Jami Chiqim</div><div class="detail-value" style="color:var(--accent-red)">'+formatNum(total)+'</div></div><div class="detail-item"><div class="detail-label">Operatsiyalar</div><div class="detail-value">'+ops.length+'</div></div></div>';
                if(ops.length>0){html+='<h4 style="margin:14px 0 8px;font-weight:700">üìã Chiqim operatsiyalari</h4><div class="history-scroll"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Miqdor</th><th>Sana</th></tr></thead><tbody>';ops.slice(0,50).forEach((op,i)=>{const m=appData.materials.find(x=>x.id===op.materialId);html+='<tr><td>'+(i+1)+'</td><td><span class="material-code">'+(m?.code||'-')+'</span></td><td>'+(m?.name||'-')+'</td><td style="color:var(--accent-red)"><strong>'+formatNum(op.qty)+'</strong></td><td>'+formatDate(op.date)+'</td></tr>'});html+='</tbody></table></div>'}
            }else{
                const today=getToday();
                if(type==='total')mats=appData.materials;
                else if(type==='ok')mats=appData.materials.filter(m=>getMaterialStatus(m).status==='ok');
                else if(type==='warning')mats=appData.materials.filter(m=>getMaterialStatus(m).status==='warning');
                else if(type==='critical')mats=appData.materials.filter(m=>getMaterialStatus(m).status==='critical');
                else if(type==='expired')mats=appData.materials.filter(m=>getMaterialStatus(m).status==='expired');
                else if(type==='renewed')mats=appData.materials.filter(m=>getMaterialStatus(m).status==='renewed');
                
                html='<div class="detail-grid"><div class="detail-item"><div class="detail-label">Materiallar</div><div class="detail-value">'+mats.length+'</div></div><div class="detail-item"><div class="detail-label">Foiz</div><div class="detail-value">'+pct(mats.length,appData.materials.length)+'%</div></div></div>';
                if(mats.length>0){html+='<h4 style="margin:14px 0 8px;font-weight:700">üìã Materiallar</h4><div class="history-scroll"><table><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Min</th><th>Qoldiq</th><th>Status</th></tr></thead><tbody>';mats.forEach((m,i)=>{const q=getMaterialQty(m.id);const st=getMaterialStatus(m);html+='<tr><td>'+(i+1)+'</td><td><span class="material-code">'+m.code+'</span></td><td>'+m.name+'</td><td style="color:var(--accent-orange)">'+(m.minQty||10)+'</td><td><strong>'+formatNum(q)+'</strong></td><td><span class="badge badge-'+st.class+'">'+st.label+'</span></td></tr>'});html+='</tbody></table></div>'}
            }
            document.getElementById('stat-detail-title').textContent=titles[type];
            document.getElementById('stat-detail-content').innerHTML=html;
            openModal('stat-detail-modal');
        }
        
        // EXPORTS
        function exportMaterialsExcel(){const data=appData.materials.map((m,i)=>({'‚Ññ':i+1,'Kod':m.code,'Nomi':m.name,'Birlik':m.unit,'Min':m.minQty||10,'Kirim':getMaterialKirim(m.id),'Chiqim':getMaterialChiqim(m.id),'NG':getMaterialNG(m.id),'Qoldiq':getMaterialQty(m.id)}));exportExcel(data,'materiallar_'+getToday()+'.xlsx','Materiallar')}
        function exportHistoryExcel(){const types={kirim:'Kirim',chiqim:'Chiqim',ng:'NG',renew:'Yangilash',initial:'Qoldiq',restore:'Qaytarish'};const filteredOps=getFilteredOperations();const data=filteredOps.map(op=>{const m=appData.materials.find(x=>x.id===op.materialId);const pIdx=getPartiyaIndex(op.materialId,op.partiyaId);return {'ID':op.id,'Sana':op.date,'Material':m?.code||'-','Nomi':m?.name||'-','Turi':types[op.type]||op.type,'Partiya':'P'+pIdx,'Miqdor':op.qty,'Izoh':op.note||''}}).sort((a,b)=>b.ID-a.ID);exportExcel(data,'tarix_'+getToday()+'.xlsx','Tarix')}
        function exportNGExcel(){const reasons={expired:'Muddat o\'tgan',damaged:'Buzilgan',quality:'Sifatsiz'};const data=appData.ngRecords.filter(n=>!n.restored).map(n=>{const pIdx=getPartiyaIndex(n.materialId,n.partiyaId);return {'ID':n.id,'Material':n.materialCode,'Nomi':n.materialName,'Miqdor':n.qty,'Sabab':reasons[n.reason]||n.reason,'Partiya':'P'+pIdx,'Sana':n.date}});exportExcel(data,'ng_'+getToday()+'.xlsx','NG')}
        function exportSummaryExcel(){const data=appData.materials.map((m,i)=>({'‚Ññ':i+1,'Kod':m.code,'Nomi':m.name,'Min':m.minQty||10,'Kirim':getMaterialKirim(m.id),'Chiqim':getMaterialChiqim(m.id),'NG':getMaterialNG(m.id),'Qoldiq':getMaterialQty(m.id)}));exportExcel(data,'xulosa_'+getToday()+'.xlsx','Xulosa')}
        function exportExpiryExcel(){const today=getToday();const data=appData.partiyalar.filter(p=>p.currentQty>0).map(p=>{const m=appData.materials.find(x=>x.id===p.materialId);const pIdx=getPartiyaIndex(p.materialId,p.id);let status='OK';if(p.renewed)status='Yangilangan';else if(p.expiryEnd&&p.expiryEnd<today)status='O\'tgan';return {'Material':m?.code||'-','Nomi':m?.name||'-','Partiya':'P'+pIdx,'Muddat':p.expiryEnd,'Qoldiq':p.currentQty,'Status':status}});exportExcel(data,'yaroqlilik_'+getToday()+'.xlsx','Yaroqlilik')}
        function exportCertificatesExcel(){const data=appData.certificates.map(c=>({'ID':c.id,'Material':c.materialCode,'Nomi':c.materialName,'Fayl':c.fileName,'Yangi muddat':c.newExpiryEnd,'Sana':c.createdAt?.split('T')[0]}));exportExcel(data,'sertifikatlar_'+getToday()+'.xlsx','Sertifikatlar')}
        function exportExpiringExcel(){const today=new Date();const tenDaysLater=new Date(today.getTime()+10*24*60*60*1000).toISOString().split('T')[0];const todayStr=getToday();const expiringParts=appData.partiyalar.filter(p=>p.currentQty>0&&!p.renewed&&p.expiryEnd&&p.expiryEnd>=todayStr&&p.expiryEnd<=tenDaysLater);const data=expiringParts.map(p=>{const m=appData.materials.find(x=>x.id===p.materialId);const pIdx=getPartiyaIndex(p.materialId,p.id);const daysLeft=Math.ceil((new Date(p.expiryEnd)-today)/(1000*60*60*24));return {'Material':m?.code||'-','Nomi':m?.name||'-','Partiya':'P'+pIdx,'Muddat':p.expiryEnd,'Qolgan kun':daysLeft,'Qoldiq':p.currentQty}});exportExcel(data,'muddati_yaqin_'+getToday()+'.xlsx','Muddati Yaqin')}
        function exportAllToExcel(){const wb=XLSX.utils.book_new();const mats=appData.materials.map((m,i)=>({'‚Ññ':i+1,'Kod':m.code,'Nomi':m.name,'Min':m.minQty||10,'Kirim':getMaterialKirim(m.id),'Chiqim':getMaterialChiqim(m.id),'NG':getMaterialNG(m.id),'Qoldiq':getMaterialQty(m.id)}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(mats),'Materiallar');const types={kirim:'Kirim',chiqim:'Chiqim',ng:'NG',renew:'Yangilash',initial:'Qoldiq',restore:'Qaytarish'};const hist=appData.operations.map(op=>{const m=appData.materials.find(x=>x.id===op.materialId);const pIdx=getPartiyaIndex(op.materialId,op.partiyaId);return {'ID':op.id,'Sana':op.date,'Material':m?.code||'-','Turi':types[op.type]||op.type,'Partiya':'P'+pIdx,'Miqdor':op.qty}}).sort((a,b)=>b.ID-a.ID);XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(hist),'Tarix');const reasons={expired:'Muddat o\'tgan',damaged:'Buzilgan',quality:'Sifatsiz'};const ngData=appData.ngRecords.map(n=>({'ID':n.id,'Material':n.materialCode,'Nomi':n.materialName,'Miqdor':n.qty,'Sabab':reasons[n.reason]||n.reason,'Sana':n.date,'Qaytarildi':n.restored?'Ha':'Yo\'q'}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(ngData),'NG');const partData=appData.partiyalar.map(p=>{const m=appData.materials.find(x=>x.id===p.materialId);const pIdx=getPartiyaIndex(p.materialId,p.id);return {'ID':p.id,'Material':m?.code||'-','Partiya':'P'+pIdx,'Muddat':p.expiryEnd,'Boshlangich':p.initialQty,'Qoldiq':p.currentQty,'Yangilangan':p.renewed?'Ha':'Yo\'q'}});XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(partData),'Partiyalar');XLSX.writeFile(wb,'byd_ombor_'+getToday()+'.xlsx');showToast('Excel tayyor!')}
        function exportExcel(data,filename,sheetname){const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,sheetname);XLSX.writeFile(wb,filename);showToast('Excel tayyor!')}
        
        // EXPIRING SOON
        function renderExpiringSoon(){const tbody=document.getElementById('expiring-table-list');const today=new Date();const tenDaysLater=new Date(today.getTime()+10*24*60*60*1000).toISOString().split('T')[0];const todayStr=getToday();const expiringParts=appData.partiyalar.filter(p=>p.currentQty>0&&!p.renewed&&p.expiryEnd&&p.expiryEnd>=todayStr&&p.expiryEnd<=tenDaysLater).sort((a,b)=>new Date(a.expiryEnd)-new Date(b.expiryEnd));if(!expiringParts.length){tbody.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="icon">‚úÖ</div><h3>Ajoyib!</h3><p>Muddati yaqin material yo\'q</p></div></td></tr>';return}tbody.innerHTML=expiringParts.map((p,i)=>{const m=appData.materials.find(x=>x.id===p.materialId);const pIdx=getPartiyaIndex(p.materialId,p.id);const daysLeft=Math.ceil((new Date(p.expiryEnd)-today)/(1000*60*60*24));let badgeClass='warning';if(daysLeft<=3)badgeClass='danger';else if(daysLeft<=7)badgeClass='warning';return '<tr><td>'+(i+1)+'</td><td><span class="material-code">'+(m?.code||'-')+'</span></td><td>'+(m?.name||'-')+'</td><td>P'+pIdx+'</td><td>'+formatDate(p.expiryEnd)+'</td><td><span class="badge badge-'+badgeClass+'">'+daysLeft+' kun</span></td><td><strong>'+formatNum(p.currentQty)+'</strong></td><td><span class="badge badge-warning">‚è∞ Yaqin</span></td></tr>'}).join('')}
        
        // OPERATION EDIT/DELETE
        function editOperation(opId){const op=appData.operations.find(o=>o.id===opId);if(!op)return;const types={kirim:'üì• Kirim',chiqim:'üì§ Chiqim',ng:'‚ö†Ô∏è NG',renew:'üîÑ Yangilash',initial:'üì¶ Qoldiq',restore:'‚ôªÔ∏è Qaytarish'};document.getElementById('edit-op-id').value=op.id;document.getElementById('edit-op-type').value=types[op.type]||op.type;document.getElementById('edit-op-qty').value=op.qty;document.getElementById('edit-op-date').value=op.date;document.getElementById('edit-op-note').value=op.note||'';openModal('operation-edit-modal')}
        async function saveOperationEdit(){const opId=parseInt(document.getElementById('edit-op-id').value);const qty=parseFloat(document.getElementById('edit-op-qty').value);const date=document.getElementById('edit-op-date').value;const note=document.getElementById('edit-op-note').value;try{await api('/api/operations/'+opId,{method:'PUT',body:JSON.stringify({qty,date,note})});closeModal('operation-edit-modal');showToast('Operatsiya yangilandi!');await loadAllData();if(window.currentHistoryMaterialId){showMaterialHistory(window.currentHistoryMaterialId)}}catch(e){showToast(e.message,'error')}}
        function deleteOperation(opId){const op=appData.operations.find(o=>o.id===opId);if(!op)return;const m=appData.materials.find(x=>x.id===op.materialId);document.getElementById('confirm-message').innerHTML='<strong>#'+opId+'</strong> operatsiyani o\'chirmoqchimisiz?<br><small>'+formatNum(op.qty)+' - '+(m?.code||'-')+'</small>';document.getElementById('confirm-btn').onclick=async()=>{try{await api('/api/operations/'+opId,{method:'DELETE'});closeModal('confirm-modal');showToast('Operatsiya o\'chirildi!');await loadAllData();if(window.currentHistoryMaterialId){showMaterialHistory(window.currentHistoryMaterialId)}}catch(e){showToast(e.message,'error')}};openModal('confirm-modal')}
        
        async function handleExcelImport(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async function(ev){try{const wb=XLSX.read(ev.target.result,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const data=XLSX.utils.sheet_to_json(ws);const materials=data.map(row=>({code:String(row['Kod']||row['Code']||'').trim(),name:String(row['Nomi']||row['Name']||'').trim(),unit:String(row['Birlik']||row['Unit']||'litr').trim(),expiryMonths:parseInt(row['Yaroqlilik']||row['Expiry']||12),initialQty:parseFloat(row['Miqdor']||row['Qty']||row['Qoldiq']||0)})).filter(m=>m.code&&m.name);if(!materials.length){showToast('Ma\'lumot topilmadi','warning');return}const result=await api('/api/import',{method:'POST',body:JSON.stringify({materials})});showToast(result.imported+' qo\'shildi, '+result.updated+' yangilandi');await loadAllData()}catch(err){showToast('Xatolik: '+err.message,'error')}};reader.readAsArrayBuffer(file);e.target.value=''}
        function downloadTemplate(){const ws=XLSX.utils.aoa_to_sheet([['Kod','Nomi','Birlik','Yaroqlilik','Miqdor'],['ABC-001','Namuna','litr',12,100]]);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Shablon');XLSX.writeFile(wb,'byd_shablon.xlsx')}
        
        async function exportBackup(){try{const data=await api('/api/backup');const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='byd_backup_'+getToday()+'.json';a.click();URL.revokeObjectURL(url);showToast('Backup tayyor!')}catch(e){showToast(e.message,'error')}}
        async function importBackup(e){const file=e.target.files[0];if(!file)return;if(!confirm('Barcha ma\'lumotlar o\'zgaradi. Davom etasizmi?')){e.target.value='';return}const reader=new FileReader();reader.onload=async function(ev){try{const data=JSON.parse(ev.target.result);await api('/api/restore',{method:'POST',body:JSON.stringify(data)});showToast('Tiklandi!');await loadAllData()}catch(err){showToast('Xatolik','error')}};reader.readAsText(file);e.target.value=''}
        function openDeleteAllModal(){document.getElementById('delete-all-confirm').value='';openModal('delete-all-modal')}
        async function executeDeleteAll(){const confirmation=document.getElementById('delete-all-confirm').value.trim();if(confirmation!=="o'chirib yuborilsin"){showToast("Tasdiqlash noto'g'ri! \"o'chirib yuborilsin\" deb yozing",'error');return}
        // Export all data first
        try{showToast('Ma\'lumotlar export qilinmoqda...','info');const wb=XLSX.utils.book_new();const mats=appData.materials.map((m,i)=>({'‚Ññ':i+1,'Kod':m.code,'Nomi':m.name,'Min':m.minQty||10,'Kirim':getMaterialKirim(m.id),'Chiqim':getMaterialChiqim(m.id),'NG':getMaterialNG(m.id),'Qoldiq':getMaterialQty(m.id)}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(mats),'Materiallar');const types={kirim:'Kirim',chiqim:'Chiqim',ng:'NG',renew:'Yangilash',initial:'Qoldiq',restore:'Qaytarish'};const hist=appData.operations.map(op=>{const m=appData.materials.find(x=>x.id===op.materialId);const pIdx=getPartiyaIndex(op.materialId,op.partiyaId);return {'ID':op.id,'Sana':op.date,'Material':m?.code||'-','Turi':types[op.type]||op.type,'Partiya':'P'+pIdx,'Miqdor':op.qty,'Izoh':op.note||''}}).sort((a,b)=>b.ID-a.ID);XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(hist),'Tarix');const reasons={expired:'Muddat o\'tgan',damaged:'Buzilgan',quality:'Sifatsiz'};const ngData=appData.ngRecords.map(n=>({'ID':n.id,'Material':n.materialCode,'Nomi':n.materialName,'Miqdor':n.qty,'Sabab':reasons[n.reason]||n.reason,'Sana':n.date,'Qaytarildi':n.restored?'Ha':'Yo\'q'}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(ngData),'NG');const partData=appData.partiyalar.map(p=>{const m=appData.materials.find(x=>x.id===p.materialId);const pIdx=getPartiyaIndex(p.materialId,p.id);return {'ID':p.id,'Material':m?.code||'-','Partiya':'P'+pIdx,'Muddat':p.expiryEnd,'Boshlangich':p.initialQty,'Qoldiq':p.currentQty,'Yangilangan':p.renewed?'Ha':'Yo\'q'}});XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(partData),'Partiyalar');const certData=appData.certificates.map(c=>({'ID':c.id,'Material':c.materialCode,'Nomi':c.materialName,'Fayl':c.fileName,'Yangi muddat':c.newExpiryEnd}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(certData),'Sertifikatlar');XLSX.writeFile(wb,'byd_backup_'+getToday()+'.xlsx');
        // Now delete
        await api('/api/delete-all-operations',{method:'POST',body:JSON.stringify({confirmation})});closeModal('delete-all-modal');showToast("Barcha operatsiyalar o'chirildi! Backup yuklandi.");await loadAllData()}catch(err){showToast(err.message,'error')}}
        function updateSettingsInfo(){document.getElementById('info-mats').textContent=appData.materials.length;document.getElementById('info-parts').textContent=appData.partiyalar.length;document.getElementById('info-ops').textContent=appData.operations.length;document.getElementById('info-certs').textContent=appData.certificates.length}
        async function changeCredentials(e){e.preventDefault();const cur=document.getElementById('current-password').value,nl=document.getElementById('new-login').value.trim(),np=document.getElementById('new-password').value,cp=document.getElementById('confirm-password').value;if(np!==cp){showToast('Parollar mos emas!','error');return}try{await api('/api/change-password',{method:'POST',body:JSON.stringify({currentPassword:cur,newLogin:nl,newPassword:np})});document.getElementById('current-user').textContent=nl;currentUser.username=nl;['current-password','new-password','confirm-password'].forEach(id=>document.getElementById(id).value='');showToast('Saqlandi!')}catch(e){showToast(e.message,'error')}}
        function showSection(id,btn){document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));document.getElementById('section-'+id).classList.add('active');document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));if(btn)btn.classList.add('active')}
        
        // ULTRA MODERN PRESENTATION
        function createParticles(){const container=document.getElementById('presentation-particles');container.innerHTML='';for(let i=0;i<30;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.animationDelay=Math.random()*20+'s';p.style.animationDuration=(15+Math.random()*10)+'s';container.appendChild(p)}}
        
        async function startPresentation(){
            const today=getToday();const total=appData.materials.length;
            let s={ok:0,warning:0,critical:0,expired:0,renewed:0,ng:0};
            const activeNG=appData.ngRecords.filter(n=>!n.restored);
            s.ng=activeNG.length;
            
            appData.materials.forEach(m=>{
                const st=getMaterialStatus(m);
                if(st.status==='renewed')s.renewed++;
                else if(st.status==='expired')s.expired++;
                else if(st.status==='critical')s.critical++;
                else if(st.status==='warning')s.warning++;
                else s.ok++;
            });
            
            const totalKirim=appData.operations.filter(o=>o.type==='kirim').reduce((sum,o)=>sum+precise(o.qty),0);
            const totalChiqim=appData.operations.filter(o=>o.type==='chiqim').reduce((sum,o)=>sum+precise(o.qty),0);
            const totalQoldiq=appData.partiyalar.reduce((sum,p)=>sum+precise(p.currentQty||0),0);
            const ngQty=activeNG.reduce((s,n)=>s+precise(n.qty),0);
            
            presentationStats={
                total,s,totalKirim,totalChiqim,totalQoldiq,ngQty,
                activeNGList:activeNG,
                topKirim:appData.materials.map(m=>({code:m.code,name:m.name,qty:appData.operations.filter(o=>o.materialId===m.id&&o.type==='kirim').reduce((s,o)=>s+precise(o.qty),0)})).filter(x=>x.qty>0).sort((a,b)=>b.qty-a.qty).slice(0,8),
                topChiqim:appData.materials.map(m=>({code:m.code,name:m.name,qty:appData.operations.filter(o=>o.materialId===m.id&&o.type==='chiqim').reduce((s,o)=>s+precise(o.qty),0)})).filter(x=>x.qty>0).sort((a,b)=>b.qty-a.qty).slice(0,8),
                expiredMaterials:appData.materials.filter(m=>getMaterialStatus(m).status==='expired').map(m=>({code:m.code,name:m.name,qty:getMaterialQty(m.id)})),
                criticalMaterials:[...appData.materials.filter(m=>getMaterialStatus(m).status==='critical'||getMaterialStatus(m).status==='warning').map(m=>({code:m.code,name:m.name,qty:getMaterialQty(m.id),minQty:m.minQty||10,type:'material'})),...activeNG.filter(n=>{const m=appData.materials.find(x=>x.id===n.materialId);const minQty=m?.minQty||10;return n.qty<=minQty}).map(n=>({code:n.materialCode,name:n.materialName+' (NG)',qty:n.qty,minQty:0,type:'ng'}))],
                renewedMaterials:appData.materials.filter(m=>getMaterialStatus(m).status==='renewed').map(m=>({code:m.code,name:m.name,qty:getMaterialQty(m.id)}))
            };
            
            currentSlide=0;
            createParticles();
            renderSlide();
            document.getElementById('presentation-overlay').classList.add('active');
            renderNavDots();
        }
        
        function endPresentation(){document.getElementById('presentation-overlay').classList.remove('active')}
        function nextSlide(){if(currentSlide<totalSlides-1){currentSlide++;renderSlide();updateNavDots()}}
        function prevSlide(){if(currentSlide>0){currentSlide--;renderSlide();updateNavDots()}}
        function goToSlide(n){currentSlide=n;renderSlide();updateNavDots()}
        function renderNavDots(){let html='';for(let i=0;i<totalSlides;i++){html+='<button class="nav-dot '+(i===0?'active':'')+'" onclick="goToSlide('+i+')"></button>'}document.getElementById('presentation-nav').innerHTML=html}
        function updateNavDots(){document.querySelectorAll('.nav-dot').forEach((d,i)=>d.classList.toggle('active',i===currentSlide));document.getElementById('slide-counter').textContent=(currentSlide+1)+' / '+totalSlides}
        
        function renderSlide(){
            const container=document.getElementById('presentation-content');
            const today=new Date().toLocaleDateString('uz-UZ',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
            const st=presentationStats;
            const total=st.total;const s=st.s;
            
            const slides=[
                // Slide 1: Title
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üöó</span><div class="slide-title">BYD Kimyoviy Materiallar</div><div class="slide-subtitle">Saqlash Ombori - Kunlik Hisobot</div><div class="slide-date">üìÖ ${today}</div></div><div class="slide-stats"><div class="slide-stat blue"><div class="slide-stat-icon">üì¶</div><div class="slide-stat-value">${total}</div><div class="slide-stat-label">Materiallar</div></div><div class="slide-stat purple"><div class="slide-stat-icon">üè∑Ô∏è</div><div class="slide-stat-value">${appData.partiyalar.length}</div><div class="slide-stat-label">Partiyalar</div></div><div class="slide-stat cyan"><div class="slide-stat-icon">üìã</div><div class="slide-stat-value">${appData.operations.length}</div><div class="slide-stat-label">Operatsiyalar</div></div><div class="slide-stat green"><div class="slide-stat-icon">üìú</div><div class="slide-stat-value">${appData.certificates.length}</div><div class="slide-stat-label">Sertifikatlar</div></div></div><div class="slide-footer"><div class="logo"><span>üöó BYD</span> UZBEKISTAN FACTORY</div><p>Kimyoviy materiallar saqlash ombori boshqaruv tizimi</p></div></div>`,
                
                // Slide 2: Material Flow
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üìä</span><div class="slide-title">Umumiy Material Oqimi</div><div class="slide-subtitle">Kirim, Chiqim va Qoldiq statistikasi</div></div><div class="slide-stats"><div class="slide-stat green"><div class="slide-stat-icon">üì•</div><div class="slide-stat-value">${formatNum(st.totalKirim)}</div><div class="slide-stat-label">Jami Kirim</div></div><div class="slide-stat red"><div class="slide-stat-icon">üì§</div><div class="slide-stat-value">${formatNum(st.totalChiqim)}</div><div class="slide-stat-label">Jami Chiqim</div></div><div class="slide-stat orange"><div class="slide-stat-icon">üö´</div><div class="slide-stat-value">${s.ng}</div><div class="slide-stat-label">NG (${formatNum(st.ngQty)})</div></div><div class="slide-stat blue"><div class="slide-stat-icon">üí∞</div><div class="slide-stat-value">${formatNum(st.totalQoldiq)}</div><div class="slide-stat-label">Jami Qoldiq</div></div></div><div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 3: Material Status
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üìà</span><div class="slide-title">Material Holatlari</div><div class="slide-subtitle">Joriy zaxira tahlili</div></div><div class="slide-stats"><div class="slide-stat green"><div class="slide-stat-icon">‚úÖ</div><div class="slide-stat-value">${s.ok}</div><div class="slide-stat-label">Yetarli</div><div class="slide-stat-sub">${pct(s.ok,total)}%</div></div><div class="slide-stat orange"><div class="slide-stat-icon">‚ö†Ô∏è</div><div class="slide-stat-value">${s.warning}</div><div class="slide-stat-label">Kam</div><div class="slide-stat-sub">${pct(s.warning,total)}%</div></div><div class="slide-stat red"><div class="slide-stat-icon">üö®</div><div class="slide-stat-value">${s.critical}</div><div class="slide-stat-label">Kritik</div><div class="slide-stat-sub">${pct(s.critical,total)}%</div></div><div class="slide-stat cyan"><div class="slide-stat-icon">üîÑ</div><div class="slide-stat-value">${s.renewed}</div><div class="slide-stat-label">Yangilangan</div><div class="slide-stat-sub">${pct(s.renewed,total)}%</div></div></div><div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 4: Expired
                `<div class="slide"><div class="slide-header"><span class="slide-icon">‚è∞</span><div class="slide-title">Muddati O'tgan Materiallar</div><div class="slide-subtitle">Shoshilinch e'tibor talab qiladi!</div></div>${st.expiredMaterials?.length>0?`<div class="slide-stats"><div class="slide-stat red"><div class="slide-stat-icon">‚ùå</div><div class="slide-stat-value">${s.expired}</div><div class="slide-stat-label">Muddat o'tgan</div></div></div><div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Qoldiq</th></tr></thead><tbody>${st.expiredMaterials.slice(0,6).map((m,i)=>`<tr><td>${i+1}</td><td><span class="code">${m.code}</span></td><td>${m.name}</td><td class="value red">${formatNum(m.qty)}</td></tr>`).join('')}</tbody></table></div>`:`<div class="slide-empty"><div class="icon">‚úÖ</div><h3>Ajoyib!</h3><p>Muddati o'tgan material yo'q</p></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 5: NG
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üö´</span><div class="slide-title">NG Materiallar</div><div class="slide-subtitle">Yaroqsiz materiallar ro'yxati</div></div>${st.activeNGList?.length>0?`<div class="slide-stats"><div class="slide-stat orange"><div class="slide-stat-icon">üì¶</div><div class="slide-stat-value">${s.ng}</div><div class="slide-stat-label">NG soni</div></div><div class="slide-stat orange"><div class="slide-stat-icon">üìä</div><div class="slide-stat-value">${formatNum(st.ngQty)}</div><div class="slide-stat-label">Jami miqdor</div></div></div><div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Material</th><th>Miqdor</th><th>Sabab</th></tr></thead><tbody>${st.activeNGList.slice(0,6).map((n,i)=>`<tr><td>${i+1}</td><td><span class="code">${n.materialCode}</span></td><td class="value orange">${formatNum(n.qty)}</td><td>${n.reason==='expired'?'üìÖ Muddat':n.reason==='damaged'?'üíî Buzilgan':'üî¨ Sifatsiz'}</td></tr>`).join('')}</tbody></table></div>`:`<div class="slide-empty"><div class="icon">‚úÖ</div><h3>Yaxshi!</h3><p>Faol NG yo'q</p></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 6: Top Kirim
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üì•</span><div class="slide-title">Top Kirim Materiallar</div><div class="slide-subtitle">Eng ko'p kirim qilingan materiallar</div></div>${st.topKirim?.length>0?`<div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Kirim</th></tr></thead><tbody>${st.topKirim.map((x,i)=>`<tr><td>${i+1}</td><td><span class="code">${x.code}</span></td><td>${x.name}</td><td class="value green">${formatNum(x.qty)}</td></tr>`).join('')}</tbody></table></div>`:`<div class="slide-empty"><p>Ma'lumot yo'q</p></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 7: Top Chiqim
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üì§</span><div class="slide-title">Top Chiqim Materiallar</div><div class="slide-subtitle">Eng ko'p chiqim qilingan materiallar</div></div>${st.topChiqim?.length>0?`<div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Chiqim</th></tr></thead><tbody>${st.topChiqim.map((x,i)=>`<tr><td>${i+1}</td><td><span class="code">${x.code}</span></td><td>${x.name}</td><td class="value red">${formatNum(x.qty)}</td></tr>`).join('')}</tbody></table></div>`:`<div class="slide-empty"><p>Ma'lumot yo'q</p></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 8: Critical
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üö®</span><div class="slide-title">Kritik Holatlar</div><div class="slide-subtitle">Zaxirasi tugagan yoki minimum darajada (NG ham)</div></div>${st.criticalMaterials?.length>0?`<div class="slide-stats"><div class="slide-stat red"><div class="slide-stat-icon">üö®</div><div class="slide-stat-value">${s.critical}</div><div class="slide-stat-label">Kritik</div></div><div class="slide-stat orange"><div class="slide-stat-icon">‚ö†Ô∏è</div><div class="slide-stat-value">${s.warning}</div><div class="slide-stat-label">Kam</div></div></div><div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Qoldiq</th><th>Min</th><th>Turi</th></tr></thead><tbody>${st.criticalMaterials.slice(0,8).map((m,i)=>`<tr><td>${i+1}</td><td><span class="code">${m.code}</span></td><td>${m.name}</td><td class="value ${m.type==='ng'?'orange':'red'}">${formatNum(m.qty)}</td><td>${m.minQty}</td><td>${m.type==='ng'?'üö´ NG':'üì¶'}</td></tr>`).join('')}</tbody></table></div>`:`<div class="slide-empty"><div class="icon">‚úÖ</div><h3>Hammasi yaxshi!</h3><p>Kritik holat yo'q</p></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 9: Renewed
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üîÑ</span><div class="slide-title">Yangilangan Muddatlar</div><div class="slide-subtitle">Sertifikat bilan yangilangan materiallar</div></div>${st.renewedMaterials?.length>0||appData.certificates.length>0?`<div class="slide-stats"><div class="slide-stat cyan"><div class="slide-stat-icon">üîÑ</div><div class="slide-stat-value">${s.renewed}</div><div class="slide-stat-label">Yangilangan</div></div><div class="slide-stat purple"><div class="slide-stat-icon">üìú</div><div class="slide-stat-value">${appData.certificates.length}</div><div class="slide-stat-label">Sertifikatlar</div></div></div>${st.renewedMaterials?.length>0?`<div class="slide-table-container"><table class="slide-table"><thead><tr><th>‚Ññ</th><th>Kod</th><th>Nomi</th><th>Qoldiq</th></tr></thead><tbody>${st.renewedMaterials.slice(0,5).map((m,i)=>`<tr><td>${i+1}</td><td><span class="code">${m.code}</span></td><td>${m.name}</td><td class="value">${formatNum(m.qty)}</td></tr>`).join('')}</tbody></table></div>`:''}`:`<div class="slide-empty"><div class="icon">üìú</div><h3>Yangilangan yo'q</h3></div>`}<div class="slide-footer"><div class="logo"><span>üöó BYD</span> Kimyoviy Materiallar</div></div></div>`,
                
                // Slide 10: Summary
                `<div class="slide"><div class="slide-header"><span class="slide-icon">üìä</span><div class="slide-title">Yakuniy Xulosa</div><div class="slide-subtitle">Umumiy holat va tavsiyalar</div><div class="slide-date">üìÖ ${today}</div></div><div class="slide-stats"><div class="slide-stat blue"><div class="slide-stat-icon">üì¶</div><div class="slide-stat-value">${total}</div><div class="slide-stat-label">Materiallar</div></div><div class="slide-stat green"><div class="slide-stat-icon">‚úÖ</div><div class="slide-stat-value">${pct(s.ok,total)}%</div><div class="slide-stat-label">Yetarli</div></div><div class="slide-stat red"><div class="slide-stat-icon">‚ö†Ô∏è</div><div class="slide-stat-value">${s.expired+s.critical}</div><div class="slide-stat-label">E'tibor talab</div></div><div class="slide-stat orange"><div class="slide-stat-icon">üö´</div><div class="slide-stat-value">${s.ng}</div><div class="slide-stat-label">NG</div></div></div><div class="slide-footer"><div class="logo"><span>üöó BYD</span> UZBEKISTAN FACTORY</div><p>Kirim: <span class="highlight">${formatNum(st.totalKirim)}</span> | Chiqim: <span class="highlight">${formatNum(st.totalChiqim)}</span> | Qoldiq: <span class="highlight">${formatNum(st.totalQoldiq)}</span></p><p style="margin-top:12px;font-size:1.1rem;font-weight:900;color:var(--primary)">‚ú® Rahmat! Hisobot tugadi ‚ú®</p></div></div>`
            ];
            
            container.innerHTML=slides[currentSlide]||slides[0];
            updateNavDots();
        }
        
        // Event listeners
        document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
        document.addEventListener('keydown',e=>{
            if(e.key==='Escape'){
                document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active'));
                if(document.getElementById('presentation-overlay').classList.contains('active'))endPresentation();
            }
            if(document.getElementById('presentation-overlay').classList.contains('active')){
                if(e.key==='ArrowRight'||e.key===' ')nextSlide();
                if(e.key==='ArrowLeft')prevSlide();
            }
        });
        document.addEventListener('DOMContentLoaded',()=>{checkAuth()});
    </script>
</body>
</html>
